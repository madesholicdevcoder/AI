<!DOCTYPE html>
<!-- Enhanced by Gemini -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Madeon by MDS.</title>
    <!-- Google Fonts For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@32,400,0,0" />
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.16/mammoth.browser.min.js"></script>
    
  </head>
  <body>
    <div class="main-content">
      <div class="container">
        
        <!-- Main Header -->
        <header class="main-header">
            <div class="header-title">
                <span class="material-symbols-rounded">auto_awesome</span>
                Madeon 2.1
            </div>
            <button class="upgrade-btn">Upgrade</button>
        </header>

        <!-- Welcome Screen (replaces suggestions) -->
        <div class="welcome-screen">
            <div class="welcome-text">
                <h1 class="welcome-title">Hi there, Ready to Achieve Great Things?</h1>
            </div>
            <div class="robot-container">
                <!-- Neo-Brutalist SVG Robot -->
                <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="25" y="35" width="50" height="40" rx="8" fill="white" stroke="black" stroke-width="3"/>
                    <rect x="15" y="50" width="10" height="20" rx="5" fill="white" stroke="black" stroke-width="3"/>
                    <rect x="75" y="50" width="10" height="20" rx="5" fill="white" stroke="black" stroke-width="3"/>
                    <rect x="35" y="15" width="30" height="20" rx="8" fill="white" stroke="black" stroke-width="3"/>
                    <rect x="42" y="50" width="16" height="8" rx="4" fill="#3B82F6" stroke="black" stroke-width="3"/>
                    <circle cx="60" cy="25" r="3" fill="black"/>
                </svg>
            </div>
            <div class="suggestion-grid">
                <div class="suggestion-card">
                    <span class="material-symbols-rounded card-icon">layers</span>
                    <h3 class="card-title">Contribute Ideas</h3>
                    <p class="card-text">Offer feedback, and manage tasks √¢‚Ç¨‚Äù all in sync.</p>
                </div>
                <div class="suggestion-card">
                    <span class="material-symbols-rounded card-icon">forum</span>
                    <h3 class="card-title">Stay Connected</h3>
                    <p class="card-text">Share ideas and align goals effortlessly with the AI Bot.</p>
                </div>
                 <div class="suggestion-card">
                    <span class="material-symbols-rounded card-icon">calendar_month</span>
                    <h3 class="card-title">Organize Your Time</h3>
                    <p class="card-text">Set clear priorities, and stay focused efficiently.</p>
                </div>
            </div>
        </div>

        <!-- Chats Container (initially hidden) -->
        <div class="chats-container"></div>

        <!-- Enhanced Prompt Input -->
<div class="prompt-container">
            
<div id="image-gen-options-container" class="image-options-container-pro" style="display: none;">
                <div class="image-option-group">
                    <label for="image-gen-model">Model</label>
                    <select id="image-gen-model" class="image-gen-select">
                        <option value="pollinations" selected>Pollinations (Default)</option>
                        <option value="black-forest-labs/FLUX.1-dev">FLUX.1-dev</option>
                        <option value="runwayml/stable-diffusion-v1-5">Stable Diffusion v1.5</option>
                        <option value="stabilityai/stable-diffusion-3-medium-diffusers">Stable Diffusion 3 Medium</option>
                        </select>
                </div>
                <div class="image-option-group">
                    <label for="image-aspect-ratio">Aspect Ratio</label>
                    <select id="image-aspect-ratio" class="image-gen-select">
                        <option value="1/1" selected>Square (1:1)</option>
                        <option value="16/9">Landscape (16:9)</option>
                        <option value="9/16">Portrait (9:16)</option>
                        </select>
                </div>
                 <div class="image-option-group" id="image-count-group" style="display: none;">
                     <label for="image-count">Image Count</label>
                    <select id="image-count" class="image-gen-select">
                        <option value="1" selected>1 Image</option>
                        <option value="2">2 Images</option>
                        <option value="3">3 Images</option>
                        <option value="4">4 Images</option>
                    </select>
                </div>
                </div>
<div id="file-previews-wrapper" class="file-previews-wrapper-pro" style="display: none;">
                </div>
            <form action="#" class="prompt-form">
                <textarea placeholder="How can I help you today?" class="prompt-input" required></textarea>
                <div class="prompt-form-controls">
                    
                    <div class="prompt-controls-left">
                        <div id="tools-menu-container" class="tools-menu-container">
                            <button type="button" id="tools-btn" class="internal-action-btn" data-tooltip="Tools">
                                <span class="material-symbols-rounded">apps</span>
                            </button>
                            <div id="tools-menu" class="tools-menu-content">
                                <div class="tools-grid">
                                    <button class="tool-grid-item" data-tool="camera">
                                        <span class="material-symbols-rounded">photo_camera</span>
                                        <span>Camera</span>
                                    </button>
                                    <button class="tool-grid-item" data-tool="photos">
                                        <span class="material-symbols-rounded">photo_library</span>
                                        <span>Photos</span>
                                    </button>
                                    <button class="tool-grid-item" data-tool="files">
                                        <span class="material-symbols-rounded">attach_file</span>
                                        <span>Files</span>
                                    </button>
                                </div>
                                <div class="tools-list">
                                    <a href="#" class="tool-list-item" data-tool="web-search">
                                        <span class="material-symbols-rounded tool-icon">travel_explore</span>
                                        <div class="tool-info">
                                            <span class="tool-name">Web search</span>
                                            <p class="tool-description">Find real-time news and info</p>
                                        </div>
                                    </a>
                                    <a href="#" class="tool-list-item" data-tool="thinking">
                                        <span class="material-symbols-rounded tool-icon">lightbulb</span>
                                        <div class="tool-info">
                                            <span class="tool-name">Thinking</span>
                                            <p class="tool-description">Longer for better answers</p>
                                        </div>
                                    </a>
                                    <a href="#" class="tool-list-item" data-tool="settings">
                                        <span class="material-symbols-rounded tool-icon">tune</span>
                                        <div class="tool-info">
                                            <span class="tool-name">Settings</span>
                                            <p class="tool-description">Manage app and chat settings</p>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" id="mic-btn" class="internal-action-btn" data-tooltip="Use Microphone">
                            <span class="material-symbols-rounded">mic</span>
                        </button>
                    </div>
                    <div class="prompt-controls-right">
                        <div class="model-dropdown-container">
                            <button type="button" id="model-dropdown-btn" class="prompt-action-btn">
                                <span id="selected-model-icon" class="material-symbols-rounded">bolt</span>
                                <span id="selected-model-name">Models</span>
                                <span class="material-symbols-rounded">expand_more</span>
                            </button>
                         <div id="model-dropdown-content" class="dropdown-content">
                                <a href="#" data-model="Madeon 2 Flash" data-icon="bolt">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">bolt</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">Madeon 2 Flash</span>
                                            <span class="model-badge fast">Fast</span>
                                        </div>
                                        <p class="model-description">Quick and efficient for everyday tasks.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="Madeon 2 Pro" data-icon="auto_awesome">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">auto_awesome</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">Madeon 2 Pro</span>
                                            <span class="model-badge pro">Pro</span>
                                        </div>
                                        <p class="model-description">Advanced, for complex reasoning.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="MDLLM 2 Search" data-icon="hub">
                                    <div class="model-icon-container">
                                         <span class="material-symbols-rounded model-icon">hub</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">MDLLM 2 Search</span>
                                            <span class="model-badge fast">Fast</span>
                                        </div>
                                        <p class="model-description">Strongest, for difficult analysis.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="MDLLM 2 Search Pro" data-icon="bubble_chart">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">bubble_chart</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">MDLLM 2 Search Pro</span>
                                            <span class="model-badge pro">Pro</span>
                                        </div>
                                        <p class="model-description">Versatile, excels at creative tasks.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="MadReason 2.5" data-icon="mediation">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">mediation</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">MadReason 2.5</span>
                                            <span class="model-badge test">Test</span>
                                        </div>
                                        <p class="model-description">Optimized for logical deduction.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="Madeon Research Turbo" data-icon="plagiarism" class="disabled">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">plagiarism</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">Madeon Research Turbo</span>
                                            <span class="model-badge test">Test</span>
                                        </div>
                                        <p class="model-description">In-depth research and analysis.</p>
                                    </div>
                                </a>
                                <a href="#" data-model="MadReason 2.5 Pro" data-icon="manage_search">
                                    <div class="model-icon-container">
                                        <span class="material-symbols-rounded model-icon">manage_search</span>
                                    </div>
                                    <div class="model-info">
                                        <div class="model-name-wrapper">
                                            <span class="model-name">MadReason 2.5 Pro</span>
                                            <span class="model-badge pro">Pro</span>
                                        </div>
                                        <p class="model-description">Advanced reasoning and research.</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <button id="send-prompt-btn" class="material-symbols-rounded">arrow_upward</button>
                    </div>
                    </div>
            </form>
            <!-- Stop Generation Button - Professional Positioning -->
<div id="stop-generation-container" class="stop-generation-container-pro" style="display: none;">
    <button id="stop-generation-btn" class="stop-generation-btn-pro">
        <span class="material-symbols-rounded">stop_circle</span> Stop Generating
    </button>
</div>

            <div class="focus-buttons-container">
                <button class="prompt-action-btn"><span class="material-symbols-rounded">edit</span> Write</button>
                <button class="prompt-action-btn"><span class="material-symbols-rounded">school</span> Learn</button>
                <button class="prompt-action-btn"><span class="material-symbols-rounded">code</span> Code</button>
                <button class="prompt-action-btn"><span class="material-symbols-rounded">self_improvement</span> Life Stuff</button>
            </div>
        </div>
      </div>
    </div>

    <!-- Hidden file input -->
<input type="file" id="file-input" accept="image/*, .pdf, .docx, .txt, .html, .css, .js, .py, .java, .c, .cpp, .h, .go, .rb, .php, .ts, .json, .xml, .yaml, .yml, .md" hidden multiple />

    <!-- Custom Modal for Deletion Confirmation -->
    <div id="delete-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h3 class="modal-title">Delete All Chats?</h3>
        <p class="modal-text">This will permanently delete your entire chat history. This action cannot be undone.</p>
        <div class="modal-actions">
          <button id="modal-cancel-btn" class="modal-button cancel">Cancel</button>
          <button id="modal-confirm-btn" class="modal-button confirm">Delete</button>
        </div>
      </div>
    </div>
    



<!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content settings-modal-content">
        <div class="settings-header">
          <h3 class="modal-title">‚öôÔ∏è Settings</h3>
          <button id="settings-close-btn" class="close-modal-btn">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
        
        <div class="settings-body">
          <!-- Theme Section -->
          <div class="settings-section">
            <h4 class="settings-section-title">üé® Theme</h4>
            <div class="settings-options">
              <button class="setting-option active" data-theme="yellow">
                <div class="theme-preview" style="background: #fde047;"></div>
                <span>Yellow (Default)</span>
              </button>
              <button class="setting-option" data-theme="pink">
                <div class="theme-preview" style="background: #fbbf24;"></div>
                <span>Orange</span>
              </button>
              <button class="setting-option" data-theme="blue">
                <div class="theme-preview" style="background: #60a5fa;"></div>
                <span>Blue</span>
              </button>
              <button class="setting-option" data-theme="green">
                <div class="theme-preview" style="background: #4ade80;"></div>
                <span>Green</span>
              </button>
            </div>
          </div>

          <!-- Chat Settings -->
          <div class="settings-section">
            <h4 class="settings-section-title">üí¨ Chat Settings</h4>
            <label class="setting-toggle">
              <input type="checkbox" id="auto-scroll-toggle" checked>
              <span class="toggle-slider"></span>
              <span class="toggle-label">Auto-scroll to bottom</span>
            </label>
            <label class="setting-toggle">
              <input type="checkbox" id="sound-toggle">
              <span class="toggle-slider"></span>
              <span class="toggle-label">Sound notifications</span>
            </label>
          </div>

          <!-- File Settings -->
          <div class="settings-section">
            <h4 class="settings-section-title">üìé File Upload</h4>
            <div class="setting-info">
              <span class="info-label">Max file size:</span>
              <span class="info-value">5 MB</span>
            </div>
            <div class="setting-info">
              <span class="info-label">Supported formats:</span>
              <span class="info-value">JPG, PNG, GIF, WEBP</span>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="settings-section danger-section">
            <h4 class="settings-section-title">‚ö†Ô∏è Danger Zone</h4>
            <button id="clear-history-btn" class="danger-btn">
              <span class="material-symbols-rounded">delete_forever</span>
              Clear Chat History
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>

    <div id="drag-drop-overlay" style="display: none;">
      <div class="drag-drop-content">
        <span class="material-symbols-rounded">upload_file</span>
        <p>Drop files anywhere to upload</p>
      </div>
    </div>
    <style>
    
/* --- NEO-BRUTALISM STYLE V2 --- */
@import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;800&display=swap");

* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; border: none; }

:root {
  --background: #fde047; --text-color: #000000; --primary-bg: #ffffff;
  --border-color: #000000; --shadow-color: #000000; --placeholder-color: #4b5563;
  --user-msg-bg: #3b82f6; --user-msg-text: #ffffff;
  --send-btn-bg: #ec4899; --send-btn-text: #000000; --danger-color: #ef4444;
  --danger-bg: #fee2e2; --success-color: #22c55e; --border-width: 3px;
  --border-radius: 8px; --shadow-offset: 5px;
  --harsh-shadow: var(--shadow-offset) var(--shadow-offset) 0px var(--shadow-color);
}

body { color: var(--text-color); background: var(--background); }

.main-content { flex-grow: 1; height: 100vh; display: flex; flex-direction: column; }
.container {
  display: flex; flex-direction: column; height: 100%;
  overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border-color) var(--background);
}
/* --- ADDED: Custom scrollbar for Webkit browsers for better UI consistency --- */
.container::-webkit-scrollbar {
    width: 12px;
}
.container::-webkit-scrollbar-track {
    background: var(--background);
}
.container::-webkit-scrollbar-thumb {
    background-color: var(--border-color);
    border-radius: 20px;
    border: 3px solid var(--background);
}

.main-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.2rem 2rem; flex-shrink: 0;
}
.header-title {
    display: flex; align-items: center; gap: 10px; font-weight: 600;
    font-size: 1.1rem;
}
.upgrade-btn {
    background: var(--border-color); color: white; padding: 10px 20px;
    font-weight: 600; cursor: pointer; border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius); box-shadow: var(--harsh-shadow);
    transition: all 0.1s ease;
}
.upgrade-btn:active { transform: translate(var(--shadow-offset), var(--shadow-offset)); box-shadow: none;}

.welcome-screen { text-align: center; padding: 2rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
body.chats-active .welcome-screen { display: none; }
.welcome-title { 
    font-size: 3rem; 
    font-weight: 800; 
    max-width: 600px; 
    margin: 0 auto 2rem auto;
    /* --- ADDED: Fluid typography for better responsiveness --- */
    font-size: clamp(1.8rem, 5vw, 3rem);
}
.robot-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 2rem;
    animation: robotFloat 3s ease-in-out infinite, shadowPulse 3s ease-in-out infinite;
}
.suggestion-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem; max-width: 900px; margin: 0 auto; text-align: left;
}
.suggestion-card {
    background: var(--primary-bg); border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow); border-radius: var(--border-radius);
    padding: 1.5rem; cursor: pointer; transition: all 0.1s ease;
}
.suggestion-card:hover { transform: translateY(-5px); box-shadow: 10px 10px 0 var(--shadow-color); }
.suggestion-card:active { transform: translate(var(--shadow-offset), var(--shadow-offset)); box-shadow: none; }
.card-icon { font-size: 2rem; margin-bottom: 1rem; }
.card-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 0.5rem; }

.chats-container { 
    display: none; 
    gap: 20px; 
    flex-direction: column; 
    padding: 2rem 3rem; 
    flex-grow: 1; 
    overflow-y: auto;
}
body.chats-active .chats-container { display: flex; }

.chats-container .message { 
    display: flex; 
    gap: 15px; 
    max-width: 990px; 
    width: 100%; 
    margin: 0 auto;
    padding: 0 1rem;
}


/* --- MODIFIED: align-items removed to allow content to flow naturally --- */
.chats-container .message .avatar { width: 43px; height: 43px; flex-shrink: 0; align-self: flex-start; border-radius: 50%; padding: 4px; background: var(--primary-bg); border: var(--border-width) solid var(--border-color); }
.chats-container .message.loading .avatar { animation: rotate 2s linear infinite; }
@keyframes rotate { 100% { transform: rotate(360deg); } }
/* --- ADDED: Message content wrapper --- */
.message-content {
    display: flex;
    flex-direction: column;
    width: 100%;
}
.chats-container .message .message-text { 
    padding: 18px 24px; 
    word-wrap: break-word; 
    font-weight: 500; 
    border: var(--border-width) solid var(--border-color); 
    box-shadow: var(--harsh-shadow); 
    white-space: pre-wrap; 
    transition: opacity 0.5s ease;
    line-height: 1.6;
}
.chats-container .message .message-text p:last-child { margin-bottom: 0; }

.chats-container .user-message .img-attachment { max-width: 100%; border-radius: var(--border-radius); margin-top: 10px; border: var(--border-width) solid var(--border-color); }

/* --- ADDED: Style for file badge in user message --- */
.chats-container .user-message .file-attachment-badge {
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: var(--border-radius);
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}
.chats-container .user-message .file-attachment-badge .material-symbols-rounded {
    font-size: 20px;
}

.chats-container .message .message-text pre { position: relative; background-color: #282c34; color: #abb2bf; padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0; border: var(--border-width) solid var(--border-color); box-shadow: var(--harsh-shadow); white-space: pre-wrap; }
.copy-code-btn { position: absolute; top: 8px; right: 8px; background: #abb2bf; color: #282c34; border: 2px solid var(--border-color); box-shadow: 3px 3px 0 var(--shadow-color); border-radius: var(--border-radius); padding: 4px 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
/* --- ADDED: Better user feedback on click for copy button --- */
.copy-code-btn:active { transform: translate(3px, 3px); box-shadow: none; }
.chats-container .bot-message { align-self: flex-start; }
.chats-container .bot-message .message-text { background: var(--primary-bg); color: var(--text-color); border-radius: var(--border-radius) var(--border-radius) var(--border-radius) 0; }
.chats-container .user-message { flex-direction: row-reverse; align-self: flex-end; }
.chats-container .user-message .message-text { display: flex; flex-direction: column; max-width: 75%; background: var(--user-msg-bg); color: var(--user-msg-text); border-radius: var(--border-radius) var(--border-radius) 0 var(--border-radius); }

/* --- ADDED: Message actions container --- */
.message-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    /* --- REMOVED: Opacity and hover rules --- */
    transition: opacity 0.3s ease;
}

/* --- ‚ñº‚ñº‚ñº PASTE NEW BLOCK HERE ‚ñº‚ñº‚ñº --- */
/* --- ADDED: Neo-Brutalism Error Card --- */
.neo-error-card {
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
    padding: 1.25rem; /* 20px */
    text-align: left;
    /* We remove the bot's default message padding */
    margin: -18px -24px; 
}

.neo-error-header {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--danger-color);
    border-bottom: var(--border-width) solid var(--border-color);
    padding-bottom: 0.75rem; /* 12px */
    margin-bottom: 1rem; /* 16px */
}

.neo-error-header .material-symbols-rounded {
    font-size: 2.25rem; /* 36px */
    font-weight: 600;
}

.neo-error-header h3 {
    font-size: 1.25rem; /* 20px */
    font-weight: 800;
    margin: 0;
}

.neo-error-message {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-color);
    line-height: 1.6;
    margin: 0;
    white-space: pre-wrap; /* Ensures error messages with newlines render correctly */
}
/* --- ‚ñ≤‚ñ≤‚ñ≤ END OF PASTED BLOCK ‚ñ≤‚ñ≤‚ñ≤ --- */

/* === Modify Response Dropdown === */
/* === Modify Response Dropdown === */
/* ===== PRODUCTION MODIFY RESPONSE MENU ===== */
.modify-response-menu {
    position: fixed; /* Changed from absolute */
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: 0 10px 40px rgba(0,0,0,0.3); /* Stronger shadow */
    padding: 8px 0;
    display: none;
    flex-direction: column;
    z-index: 10000; /* Higher than other elements */
    min-width: 220px;
    max-width: 280px;
    animation: slideUpFadeIn 0.2s ease-out;
}

.modify-response-menu.show {
    display: flex;
}

.modify-response-menu button {
    background: none;
    border: none;
    padding: 12px 16px;
    text-align: left;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
}

.modify-response-menu button .material-symbols-rounded {
    font-size: 20px;
    color: var(--placeholder-color);
}

.modify-response-menu button:hover {
    background: var(--background);
    padding-left: 20px;
}

.modify-response-menu button:hover .material-symbols-rounded {
    color: var(--user-msg-bg);
}

.modify-response-menu button:active {
    transform: scale(0.98);
}

.modify-response-menu button:not(:last-child) {
    border-bottom: 1px solid var(--background);
}

/* Loading state for modify */
.message.loading .modify-btn {
    opacity: 0.5;
    pointer-events: none;
}


.modify-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--placeholder-color);
  padding: 4px;
  border-radius: var(--border-radius);
  transition: all 0.2s;
}

.modify-btn:hover {
  background-color: #f0f0f0;
  color: var(--text-color);
}

.action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--placeholder-color);
    display: flex;
    align-items: center;
    padding: 4px;
    border-radius: var(--border-radius);
    transition: all 0.2s ease;
}
.action-btn:hover {
    background-color: #f0f0f0;
    color: var(--text-color);
}
.action-btn.active {
    color: var(--user-msg-bg);
}

/* --- ADDED: Style for "speaking" button --- */
.action-btn.speaking {
    color: var(--danger-color);
}

/* --- ADDED: Gemini-style "Thinking" Loader --- */
.gemini-loader {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
    height: 30px; /* Give it some space */
}
.gemini-loader span {
    width: 10px;
    height: 10px;
    background-color: var(--border-color);
    border-radius: 50%;
    opacity: 0.5;
    animation: pulseLoader 1.4s infinite ease-in-out both;
}
.gemini-loader span:nth-child(1) { animation-delay: -0.32s; }
.gemini-loader span:nth-child(2) { animation-delay: -0.16s; }
@keyframes pulseLoader {
  0%, 80%, 100% {
    transform: scale(0.6);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}


/* --- REMOVED: Old typing indicator, as loader replaces it --- */
/*
.message-text.typing::after { ... }
@keyframes blink { ... }
*/
/* --- ADDED: Professional Image Generation Options Panel --- */
.image-options-container-pro {
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow);
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    padding: 12px;
    display: flex;
    gap: 16px;
    animation: slideDown 0.3s ease;
}

.image-option-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.image-option-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--placeholder-color);
}

.image-gen-select {
    width: 100%;
    padding: 10px;
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
    font-weight: 500;
    font-size: 0.95rem;
    cursor: pointer;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20width%3D%27292.4%27%20height%3D%27292.4%27%3E%3Cpath%20fill%3D%27%23000000%27%20d%3D%27M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.4-5.4-13z%27%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
}

/* --- ADDED: Styles for Multi-Image Display & Loading --- */
.generated-images-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}
.generated-image-wrapper {
    flex: 1 1 calc(50% - 10px); /* Two columns layout */
    max-width: calc(50% - 5px);
    aspect-ratio: 1 / 1; /* Default to square */
    border-radius: var(--border-radius);
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow);
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.generated-image-wrapper.loading .spinner {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  border: 3px solid var(--border-color);
  border-top-color: var(--user-msg-bg);
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.generated-image-wrapper.error {
    flex-direction: column; /* Stack icon and text */
    gap: 5px;
    padding: 10px;
}
.generated-image-wrapper.error .material-symbols-rounded {
    font-size: 2rem;
    color: var(--danger-color);
}
.generated-image-wrapper.error .error-text {
    font-size: 0.8rem;
    color: var(--danger-color);
    text-align: center;
}
/* Ensure single image still looks good */
.generated-images-container:has(> :only-child) .generated-image-wrapper {
   flex-basis: 100%;
   max-width: 100%;
   aspect-ratio: auto; /* Let single image use its natural ratio */
}

/* --- Style for AI-Generated Images --- */
.chats-container .bot-message .generated-image {
    /* --- MODIFIED: Ensure image fills wrapper --- */
    width: 100%;
    height: 100%;
    object-fit: cover; /* Changed from max-width */
    border-radius: 0; /* Wrapper now has radius */
    margin-bottom: 0; /* Wrapper handles margin */
    border: none; /* Wrapper handles border */
    box-shadow: none; /* Wrapper handles shadow */
    background: transparent;
}


.prompt-container {
    padding: 1rem 2rem; flex-shrink: 0; background: var(--background);
    border-top: var(--border-width) solid var(--border-color);
    max-width: 990px; width: 100%; margin: 0 auto;
}

/* --- MODIFIED: Professional Multi-File Preview Styles --- */
.file-previews-wrapper-pro {
    display: flex;
    flex-wrap: wrap; /* Allow cards to wrap to the next line */
    gap: 10px;
    margin-bottom: 12px;
    animation: slideDown 0.3s ease;
}

.file-preview-card {
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow);
    border-radius: var(--border-radius);
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    width: 250px; /* Give cards a fixed width */
    max-width: 100%;
}

@keyframes slideDown {
    from { transform: translateY(-10px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.file-preview-card-visual {
    width: 44px;
    height: 44px;
    flex-shrink: 0;
    border-radius: var(--border-radius);
    border: var(--border-width) solid var(--border-color);
    box-shadow: 2px 2px 0 var(--shadow-color);
    display: grid;
    place-items: center;
    overflow: hidden;
    background: #f0f0f0;
}
.file-preview-card-visual img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.file-preview-card-visual .material-symbols-rounded {
    font-size: 24px;
    color: var(--placeholder-color);
}

.file-preview-card-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow: hidden; /* For text-overflow */
}

.file-preview-card-name {
    font-weight: 600;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-preview-card-size {
    font-size: 0.8rem;
    color: var(--placeholder-color);
}

/* --- ADDED: Styles for file meta (size + badge) --- */
.file-preview-card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
}
.file-type-badge {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-color);
    background: var(--background);
    padding: 2px 6px;
    border-radius: 4px;
    border: 2px solid var(--border-color);
}
/* --- END: Added styles --- */

.file-preview-card-remove {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: var(--border-radius);
    transition: all 0.2s ease;
    align-self: flex-start; /* Align to the top */
}
.file-preview-card-remove:hover {
    background: var(--danger-bg);
}
.file-preview-card-remove .material-symbols-rounded {
    color: var(--danger-color);
    font-size: 20px;
}.file-preview-card-remove .material-symbols-rounded {
    color: var(--danger-color);
    font-size: 20px;
}

/* --- REMOVED: Styles for Edit Button and Selected State --- */

/* Settings Modal Styles */

/* Settings Modal Styles */
.settings-modal-content {
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    text-align: left;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: var(--border-width) solid var(--border-color);
}

.close-modal-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: var(--border-radius);
    transition: background 0.2s;
}

.close-modal-btn:hover {
    background: #f0f0f0;
}

.settings-body {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.settings-section {
    padding: 1rem;
    background: var(--background);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
}

.settings-section-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.settings-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.setting-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.setting-option:hover {
    transform: translateY(-2px);
    box-shadow: 4px 4px 0 var(--shadow-color);
}

.setting-option.active {
    background: var(--user-msg-bg);
    color: white;
}

.theme-preview {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius);
    border: var(--border-width) solid var(--border-color);
    box-shadow: 2px 2px 0 var(--shadow-color);
}

.setting-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 8px;
    cursor: pointer;
}

.setting-toggle input[type="checkbox"] {
    display: none;
}

.toggle-slider {
    position: relative;
    width: 44px;
    height: 24px;
    background: #ddd;
    border-radius: 24px;
    border: var(--border-width) solid var(--border-color);
    transition: background 0.3s;
}

.toggle-slider::before {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    border: 2px solid var(--border-color);
    transition: transform 0.3s;
}

.setting-toggle input:checked + .toggle-slider {
    background: var(--success-color);
}

.setting-toggle input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

.toggle-label {
    flex-grow: 1;
    font-weight: 500;
}

.setting-info {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: var(--primary-bg);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    margin-bottom: 8px;
}

.info-label {
    font-weight: 600;
}

.info-value {
    color: var(--placeholder-color);
    font-weight: 500;
}

.danger-section {
    background: var(--danger-bg);
}

.danger-btn {
    width: 100%;
    padding: 12px;
    background: var(--danger-color);
    color: white;
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.1s;
}

.danger-btn:active {
    transform: translate(var(--shadow-offset), var(--shadow-offset));
    box-shadow: none;
}

.prompt-form {
    background: var(--primary-bg); border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow); border-radius: var(--border-radius);
    padding: 10px; display: flex; flex-direction: column;
}
.prompt-form textarea.prompt-input {
    width: 100%; background: none; outline: none;
    font-size: 1rem; font-weight: 500; color: var(--text-color);
    padding: 10px; resize: none; min-height: 50px;
    scrollbar-width: none; /* --- ADDED: Hide scrollbar for a cleaner look --- */
}
.prompt-form textarea.prompt-input::-webkit-scrollbar { display: none; } /* --- ADDED: Hide scrollbar for Webkit --- */

.prompt-form-controls {
    display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
}
.prompt-controls-left, .prompt-controls-right { display: flex; align-items: center; gap: 10px; }
.internal-action-btn {
    width: 38px; height: 38px; border-radius: var(--border-radius);
    background: transparent; cursor: pointer; display: flex;
    align-items: center; justify-content: center;
    color: var(--placeholder-color); transition: background-color 0.2s;
    border: var(--border-width) solid transparent;
}
.internal-action-btn:hover { background-color: #f0f0f0; border-color: var(--border-color); }
/* --- ADDED: Better user feedback on click --- */
.internal-action-btn:active { transform: scale(0.95); }

/* --- ADDED: Microphone Button "Listening" Animation --- */
.internal-action-btn#mic-btn.listening {
    color: var(--danger-color);
    background-color: var(--danger-bg);
    animation: micPulse 1.2s infinite ease-in-out;
}

@keyframes micPulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
}

/* --- ADDED: Disabled state for browser incompatibility --- */
.internal-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f0f0f0;
}

#send-prompt-btn {
    width: 42px; height: 42px; border-radius: var(--border-radius);
    color: var(--send-btn-text); background: var(--send-btn-bg);
    cursor: pointer; border: var(--border-width) solid var(--border-color);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s ease;
}
#send-prompt-btn:active { transform: translate(4px, 4px); box-shadow: none; }

/* Professional Stop Generation Button Styles */
.stop-generation-container-pro {
    position: fixed;
    bottom: 120px;
    right: 20px;
    z-index: 1000;
    display: flex;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.stop-generation-btn-pro {
    background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%);
    color: white;
    padding: 12px 24px;
    font-weight: 600;
    border: 2px solid #e84118;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.stop-generation-btn-pro:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 71, 87, 0.5);
}

.stop-generation-btn-pro:active {
    transform: translateY(0);
}

/* Reviewed Badge Styles */
.reviewed-badge {
    font-size: 11px;
    color: #666;
    font-style: italic;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    user-select: none;
}

.focus-buttons-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; justify-content: center; }

.prompt-action-btn {
    background: var(--primary-bg); padding: 8px 12px; font-weight: 500;
    border: var(--border-width) solid var(--border-color); box-shadow: var(--harsh-shadow);
    border-radius: var(--border-radius); cursor: pointer; transition: all 0.1s ease;
    display: flex; align-items: center; gap: 8px;
}
.prompt-action-btn:active { transform: translate(var(--shadow-offset), var(--shadow-offset)); box-shadow: none; }

/* --- Dropdown Styles --- */
.model-dropdown-container { position: relative; display: inline-block; }
#model-dropdown-btn { padding: 8px 12px; }
.dropdown-content {
    display: none; position: absolute; bottom: 120%; right: 0;
    background-color: var(--primary-bg); min-width: 280px;
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius); box-shadow: var(--harsh-shadow); z-index: 1;
    overflow: hidden;
}
.dropdown-content a {
    color: var(--text-color);
    padding: 12px 16px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
}
.dropdown-content a:not(:last-child) {
    border-bottom: var(--border-width) solid var(--border-color);
}
.dropdown-content a:hover { background-color: #f1f1f1; }
.model-dropdown-container .show { display: block; }

.model-icon-container {
    width: 40px; height: 40px;
    flex-shrink: 0;
    display: grid;
    place-items: center;
    background-color: var(--background);
    border-radius: var(--border-radius);
    border: var(--border-width) solid var(--border-color);
}
.model-icon { font-size: 24px; transition: transform 0.3s ease; }
.model-info {
    display: flex;
    flex-direction: column;
}
.model-name { font-weight: 600; }
.model-description { font-size: 0.8rem; color: var(--placeholder-color); line-height: 1.2; }

/* --- ‚ñº‚ñº‚ñº PASTE NEW BLOCK HERE ‚ñº‚ñº‚ñº --- */
.model-name-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-badge {
    font-size: 0.7rem; /* 11.2px */
    font-weight: 700;
    padding: 2px 8px;
    border-radius: var(--border-radius);
    border: 2px solid var(--border-color);
    box-shadow: 2px 2px 0 var(--shadow-color);
    text-transform: uppercase;
}

.model-badge.fast {
    background: var(--success-color);
    color: var(--primary-bg);
}

.model-badge.pro {
    background: var(--user-msg-bg);
    color: var(--user-msg-text);
}

.model-badge.test {
    background: var(--placeholder-color);
    color: var(--primary-bg);
}

.dropdown-content a.disabled {
    opacity: 0.6;
    pointer-events: none;
    background-color: #f1f1f1;
}

.dropdown-content a.disabled .model-description::after {
    content: " (Coming Soon)";
    font-weight: 700;
    color: var(--danger-color);
}
/* --- ‚ñ≤‚ñ≤‚ñ≤ END OF PASTED BLOCK ‚ñ≤‚ñ≤‚ñ≤ --- */


/* Icon Animations on Hover */

/* Icon Animations on Hover */
.dropdown-content a:hover .model-icon[data-icon="bolt"],
.dropdown-content a:hover .model-icon[data-icon="auto_awesome"] { animation: spin 0.5s ease-in-out; }

/* Voice Dropdown Styles */
.voice-dropdown-container { 
    position: relative; 
    display: inline-block; 
    margin-left: 8px;
}

#voice-dropdown-btn { 
    padding: 6px 10px;
    background: transparent;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

#voice-dropdown-btn:hover {
    background-color: #f0f0f0;
}

.voice-dropdown-content {
    display: none; 
    position: absolute; 
    bottom: 120%; 
    right: 0;
    background-color: var(--primary-bg); 
    min-width: 260px;
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius); 
    box-shadow: var(--harsh-shadow); 
    z-index: 1001;
    overflow: hidden;
}

.voice-dropdown-content a {
    color: var(--text-color);
    padding: 12px 14px;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s;
}

.voice-dropdown-content a:not(:last-child) {
    border-bottom: var(--border-width) solid var(--border-color);
}

.voice-dropdown-content a:hover { 
    background-color: #f1f1f1; 
}

.voice-dropdown-content.show { 
    display: block; 
}

.voice-icon-container {
    width: 36px; 
    height: 36px;
    flex-shrink: 0;
    display: grid;
    place-items: center;
    background-color: var(--background);
    border-radius: var(--border-radius);
    border: var(--border-width) solid var(--border-color);
}

.voice-icon { 
    font-size: 20px; 
}

.voice-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.voice-name { 
    font-weight: 600;
    font-size: 0.95rem;
}

.voice-description { 
    font-size: 0.75rem; 
    color: var(--placeholder-color); 
    line-height: 1.2; 
}
.dropdown-content a[data-icon="bolt"]:hover .model-icon { animation: shake 0.5s ease-in-out; }
.dropdown-content a[data-icon="auto_awesome"]:hover .model-icon { animation: spin 0.8s ease; }
.dropdown-content a[data-icon="hub"]:hover .model-icon { animation: pulse 0.6s ease; }
.dropdown-content a[data-icon="bubble_chart"]:hover .model-icon { animation: float 1s ease-in-out infinite alternate; }

@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes shake {
  0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-4px); } 40%, 80% { transform: translateX(4px); }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); }
}
@keyframes float {
  from { transform: translateY(2px); } to { transform: translateY(-2px); }
}

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: var(--primary-bg); padding: 2rem; border-radius: var(--border-radius); border: var(--border-width) solid var(--border-color); box-shadow: var(--harsh-shadow); max-width: 400px; text-align: center; }
.modal-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; }
.modal-text { margin-bottom: 1.5rem; color: var(--placeholder-color); }
.modal-actions { display: flex; gap: 1rem; justify-content: center; }
.modal-button { padding: 10px 20px; font-weight: 600; cursor: pointer; border: var(--border-width) solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--harsh-shadow); transition: all 0.1s ease; }
.modal-button.cancel { background: var(--primary-bg); }
.modal-button.confirm { background: var(--danger-bg); }
.modal-button:active { transform: translate(var(--shadow-offset), var(--shadow-offset)); box-shadow: none;}
.toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 12px 24px; border-radius: var(--border-radius); border: var(--border-width) solid var(--border-color); box-shadow: var(--harsh-shadow); font-weight: 600; transition: bottom 0.5s ease-in-out; z-index: 2000; }
.toast.show { bottom: 20px; }


/* --- ADDED: Professional Tools Menu Styles --- */
.tools-menu-container {
    position: relative;
    display: inline-block;
}

#tools-btn {
    /* The internal-action-btn class already styles this well */
}

.tools-menu-content {
    display: none;
    position: absolute;
    bottom: 120%;
    left: 0;
    width: 320px;
    background-color: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
    z-index: 1001; /* Higher than other elements */
    overflow: hidden;
    animation: slideUpFadeIn 0.2s ease-out;
}

.tools-menu-content.show {
    display: block;
}

@keyframes slideUpFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    padding: 12px;
    border-bottom: var(--border-width) solid var(--border-color);
}

.tool-grid-item {
    background: var(--primary-bg);
    border: var(--border-width) solid var(--border-color);
    box-shadow: var(--harsh-shadow);
    border-radius: var(--border-radius);
    padding: 12px 8px;
    
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.1s ease;
}

.tool-grid-item .material-symbols-rounded {
    font-size: 28px;
}

.tool-grid-item:hover {
    background-color: var(--background);
    transform: translateY(-2px);
}

.tool-grid-item:active {
    transform: translate(var(--shadow-offset), var(--shadow-offset));
    box-shadow: none;
}

.tools-list {
    display: flex;
    flex-direction: column;
}

.tool-list-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    text-decoration: none;
    color: var(--text-color);
}

.tool-list-item:not(:last-child) {
    border-bottom: var(--border-width) solid var(--border-color);
}

.tool-list-item:hover {
    background-color: #f1f1f1;
}

.tool-list-item .tool-icon {
    font-size: 24px;
    color: var(--placeholder-color);
}

.tool-list-item:hover .tool-icon {
    color: var(--text-color);
}

.tool-info {
    display: flex;
    flex-direction: column;
}

.tool-name {
    font-weight: 600;
}

.tool-description {
    font-size: 0.8rem;
    color: var(--placeholder-color);
    line-height: 1.2;
}



@media (max-width: 1024px) {
    .main-header { padding: 1rem; }
    .chats-container { padding: 1.5rem 1rem; }
    .chats-container .message { padding: 0 0.5rem; }
    .chats-container .message .message-text { padding: 16px 20px; }
    .welcome-title { font-size: 2rem; }
    .suggestion-grid { grid-template-columns: 1fr; }
    .prompt-container { padding: 1rem; }
    .chats-container { padding: 1rem; }
}

@media (max-width: 768px) {
    .welcome-title { font-size: 1.8rem; }
    .robot-container { transform: scale(0.8); }
/* Animate the robot eye (circle element in SVG) */
    .robot-container svg circle {
    animation: eyeBlink 4s ease-in-out infinite;}
    .prompt-form-controls { flex-wrap: wrap; justify-content: center; gap: 10px; }
    .prompt-controls-right { width: 100%; justify-content: flex-end; }
    .focus-buttons-container { justify-content: center; }
    .prompt-action-btn { font-size: 0.9rem; padding: 6px 10px; }
    .dropdown-content { min-width: 240px; }
}

/* --- ADDED: Better layout for very small screens to improve user friendliness --- */
@media (max-width: 480px) {
    .prompt-form-controls {
        flex-direction: column;
        align-items: stretch;
    }
    .prompt-controls-left, .prompt-controls-right {
        justify-content: space-between;
        width: 100%;
    }
    .main-header {
        padding: 1rem;
        flex-direction: column;
        gap: 10px;
    }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-4px); }
}

/* === NEO-BRUTALIST ROBOT ANIMATIONS === */

/* Animation 1: Floating Bounce with Shadow Pulse */
@keyframes robotFloat {
    0%, 100% { 
        transform: translateY(0px) scale(0.8); 
    }
    50% { 
        transform: translateY(-15px) scale(0.8); 
    }
}

@keyframes shadowPulse {
    0%, 100% { 
        filter: drop-shadow(5px 5px 0px #000000); 
    }
    50% { 
        filter: drop-shadow(8px 8px 0px #000000); 
    }
}

/* Animation 2: Glitch Effect (Neo-Brutalist Style) */
@keyframes robotGlitch {
    0%, 90%, 100% { 
        transform: translate(0, 0) scale(0.8); 
    }
    20% { 
        transform: translate(-3px, 2px) scale(0.8); 
    }
    40% { 
        transform: translate(3px, -2px) scale(0.8); 
    }
    60% { 
        transform: translate(-2px, -3px) scale(0.8); 
    }
    80% { 
        transform: translate(2px, 3px) scale(0.8); 
    }
}

/* Animation 3: Bounce Landing */
@keyframes robotBounce {
    0%, 100% { 
        transform: translateY(0) scale(0.8, 0.8); 
    }
    10% { 
        transform: translateY(-20px) scale(0.85, 0.85); 
    }
    30% { 
        transform: translateY(0) scale(0.8, 0.8); 
    }
    40% { 
        transform: translateY(-10px) scale(0.82, 0.82); 
    }
    50% { 
        transform: translateY(0) scale(0.8, 0.8); 
    }
    60% { 
        transform: translateY(-5px) scale(0.81, 0.81); 
    }
    75% { 
        transform: translateY(0) scale(0.8, 0.8); 
    }
}

/* Animation 4: Eye Blink (for the robot eye) */
@keyframes eyeBlink {
    0%, 90%, 100% { 
        opacity: 1; 
    }
    95% { 
        opacity: 0; 
    }
}

/* Animation 5: Rotation Wiggle */
@keyframes robotWiggle {
    0%, 100% { 
        transform: rotate(0deg) scale(0.8); 
    }
    25% { 
        transform: rotate(-5deg) scale(0.8); 
    }
    75% { 
        transform: rotate(5deg) scale(0.8); 
    }
}

/* --- ADDED: Drag and Drop Overlay Styles --- */
#drag-drop-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 10000; /* On top of everything */
    display: grid;
    place-items: center;
    pointer-events: none; /* Allows clicks to pass through when hidden */
    backdrop-filter: blur(5px);
}

#drag-drop-overlay .drag-drop-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem 3rem;
    background: var(--primary-bg);
    border: 3px dashed var(--border-color);
    border-radius: var(--border-radius);
    box-shadow: var(--harsh-shadow);
}

#drag-drop-overlay .drag-drop-content .material-symbols-rounded {
    font-size: 4rem;
    color: var(--user-msg-bg);
}

#drag-drop-overlay .drag-drop-content p {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-color);
}

/* This class will be toggled on the <body> */
body.drag-over #drag-drop-overlay {
    display: grid;
    pointer-events: all; /* Make it interactive when visible */
}
/* --- END: Drag and Drop Overlay Styles --- */


/**/

</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const container = document.querySelector(".container");
    const chatsContainer = document.querySelector(".chats-container");
    const promptForm = document.querySelector(".prompt-form");
    const promptInput = promptForm.querySelector(".prompt-input");
    const modal = document.getElementById('delete-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    
    
    const suggestionCards = document.querySelectorAll('.suggestion-card');
    const promptActionBtns = document.querySelectorAll('.focus-buttons-container .prompt-action-btn');
    const internalActionBtns = document.querySelectorAll('.internal-action-btn');
    const modelDropdownBtn = document.getElementById('model-dropdown-btn');
    const modelDropdownContent = document.getElementById('model-dropdown-content');
    const selectedModelName = document.getElementById('selected-model-name');
    const selectedModelIcon = document.getElementById('selected-model-icon');

    // --- ADDED: Tools menu elements ---
    const toolsBtn = document.getElementById('tools-btn');
    const toolsMenu = document.getElementById('tools-menu');
    const settingsModal = document.getElementById('settings-modal'); // Ensure this is defined
    
    // --- ADDED: Stop generation elements ---
    const stopGenerationContainer = document.getElementById('stop-generation-container');
    const stopGenerationBtn = document.getElementById('stop-generation-btn');

    // --- ADDED: Speech-to-Text elements ---
    const micBtn = document.getElementById('mic-btn');
    let isListening = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let finalTranscript = '';

// File attachment elements
    const fileInput = document.getElementById('file-input');
    // --- MODIFIED: Use the new wrapper ---
    const filePreviewsWrapper = document.getElementById('file-previews-wrapper');
    
    // --- REMOVED: Old single-preview elements ---
    // const filePreviewContainer = ...
    // const filePreviewImage = ...
    // const filePreviewIcon = ...
    // const filePreviewSize = ...
    // const fileTypeBadge = ...
    // const filePreviewName = ...
    // const cancelFileBtn = ...

    let controller;
    let currentChat = { history: [] };
    let selectedModel = 'Madeon 2 Flash'; // Default model
    // --- MODIFIED: Changed from single object to array ---
    let attachedFiles = []; // To store file data
    // Voice selection state
    let selectedVoice = 'Alex'; // Default voice (male)
    let currentUtterance = null; // Track current speech

    // --- ADDED: Replicate API Token ---
// --- REMOVED: Replicate Token and sleep function ---

    // --- API Configuration ---
    // 1. Gemini Key Pool (5 keys)
    const GEMINI_API_KEYS = [
        "AIzaSyDVGMreYNNjezwcmmHJ8EtkY9qnEqEHAAg", // Your 1st Key
        "AIzaSyCi2_2RZrZB5ZnPW97ezSpU8kIWlF6Yjq4", // Your 2nd Key
        "AIzaSyDj0PZBzTFSwlnOq3-ToA5362Zg99gy4Pg", // Your 3rd Key
        "AIzaSyDz3Hs_sTFyQQ_63oQlcXcU1hlYdsNrP1A", // Your 4th Key
        "AIzaSyDSNYkim59WUWBOjNnhuU-CQ6eHg35I41A"  // Your 5th Key
    ];
    let geminiKeyIndex = 0;

    // 2. Perplexity Key Pool (2 keys)
    const PERPLEXITY_API_KEYS = [
        "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", // Your 1st Key
        "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" //
        ];
    let perplexityKeyIndex = 0;

    // 3. Hugging Face Key (remains singular)
    const HUGGINGFACE_API_KEY = "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"; // Replace
    
    // 4. Key Rotation Functions
    const getNextGeminiKey = () => {
        const key = GEMINI_API_KEYS[geminiKeyIndex];
        geminiKeyIndex = (geminiKeyIndex + 1) % GEMINI_API_KEYS.length;
        return key;
    };

    const getNextPerplexityKey = () => {
        const key = PERPLEXITY_API_KEYS[perplexityKeyIndex];
        perplexityKeyIndex = (perplexityKeyIndex + 1) % PERPLEXITY_API_KEYS.length;
        return key;
    };
    
    const API_ENDPOINTS = {
        'Madeon 2 Flash': `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=`,
        'Madeon 2 Pro': `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=`,
        'MDLLM 2 Search': 'https://api.perplexity.ai/chat/completions',
        'MDLLM 2 Search Pro': 'https://api.perplexity.ai/chat/completions',
        'MadReason 2.5': 'https://api.perplexity.ai/chat/completions',
        'Madeon Research Turbo': 'https://api.perplexity.ai/chat/completions',
        'MadReason 2.5 Pro': 'https://api.perplexity.ai/chat/completions'
    };
    
   const PERPLEXITY_MODELS = {
        'MDLLM 2 Search': 'sonar',
        'MDLLM 2 Search Pro': 'sonar-pro',
        'MadReason 2.5': 'sonar-reasoning',
        'Madeon Research Turbo': 'sonar-deep-research',
        'MadReason 2.5 Pro': 'sonar-reasoning-pro'
    };

    // --- REMOVED: REASONING_MODELS Set ---

    // --- ADDED: Global, flexible regex for image prompt detection & cleaning ---
    const IMAGE_PROMPT_REGEX = /^(generate|create|make|draw|show me an|show me a|show me the)?\s*(image|picture|photo|drawing)\s*(of)?/i;

    // --- Utility Functions ---
    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--success-color)';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    };

    const scrollToBottom = () => {
        // Debounce scrolling to prevent jerky movements during rapid message generation
        setTimeout(() => {
            container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });
        }, 100);
    };

    const createMessageElement = (content, ...classes) => {
        const div = document.createElement("div");
        div.classList.add("message", ...classes);
        div.innerHTML = content;
        return div;
    };

    // --- ‚ñº‚ñº‚ñº PASTE NEW FUNCTION HERE ‚ñº‚ñº‚ñº ---
    /**
     * Displays a standardized Neo-Brutalism error card in a bot message.
     * @param {HTMLElement} botMsgDiv - The bot message <div> to inject the error into.
     * @param {string} errorMessage - The error message to display.
     */
    const displayBotError = (botMsgDiv, errorMessage) => {
        const textElement = botMsgDiv.querySelector(".message-text");
        if (!textElement) return;

        // 1. Create the error card HTML
        // We escape the error message to prevent HTML injection (XSS)
        const escapedMessage = errorMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const errorHTML = `
            <div class="neo-error-card">
                <div class="neo-error-header">
                    <span class="material-symbols-rounded">error_outline</span>
                    <h3>Generation Failed</h3>
                </div>
                <p class="neo-error-message">${escapedMessage}</p>
            </div>
        `;
        
        // 2. Inject the HTML
        textElement.innerHTML = errorHTML;
        textElement.style.color = ''; // Reset any inline error color

        // 3. Clean up the bot message state
        botMsgDiv.classList.remove("loading");
        stopGenerationContainer.style.display = 'none';
        
        // 4. Hide message actions (like, copy, etc.) as they don't apply to an error
        const actionsDiv = botMsgDiv.querySelector('.message-actions');
        if (actionsDiv) {
            actionsDiv.style.display = 'none';
        }
        
        // 5. Hide modify button (if it was added)
        const modifyBtn = botMsgDiv.querySelector('.modify-btn');
        if (modifyBtn) {
            modifyBtn.style.display = 'none';
        }
    };
    // --- ‚ñ≤‚ñ≤‚ñ≤ END OF PASTED BLOCK ‚ñ≤‚ñ≤‚ñ≤ ---
    
    // === Modify Response Button & Menu Feature ===
    
    // === Modify Response Button & Menu Feature ===
// ===== PRODUCTION-READY MODIFY RESPONSE FEATURE =====
function addModifyResponseFeature(messageEl) {
    const messageTextEl = messageEl.querySelector('.message-text');
    if (!messageTextEl) return;

    // --- UPDATE: Initialize modify count ---
    messageEl.dataset.modifyCount = "0";
    // --- END UPDATE ---

    // Extract plain text (removing HTML/Markdown)
    const originalText = messageTextEl.textContent || messageTextEl.innerText;
    // --- FIX: Read the original markdown from the data attribute ---
    const originalMarkdown = messageTextEl.dataset.originalMarkdown || originalText;
    // --- END FIX ---

    const modifyBtn = document.createElement('button');
    modifyBtn.className = 'modify-btn action-btn';
    // --- UPDATE: Changed icon from 'tune' to 'auto_awesome' ---
    modifyBtn.innerHTML = '<span class="material-symbols-rounded">auto_awesome</span>';
    // --- END UPDATE ---
    modifyBtn.title = 'Modify response';
    modifyBtn.dataset.action = 'modify';

    const menu = document.createElement('div');
    menu.className = 'modify-response-menu';
    menu.innerHTML = `
        <button data-action="shorter"><span class="material-symbols-rounded">compress</span> Shorter</button>
        <button data-action="longer"><span class="material-symbols-rounded">expand</span> Longer</button>
        <button data-action="simpler"><span class="material-symbols-rounded">school</span> Simpler</button>
        <button data-action="casual"><span class="material-symbols-rounded">sentiment_satisfied</span> More casual</button>
        <button data-action="professional"><span class="material-symbols-rounded">business_center</span> More professional</button>
    `;

    // ===== FIX 1: Proper viewport-based positioning =====
    const positionMenu = () => {
        const btnRect = modifyBtn.getBoundingClientRect();
        const menuHeight = 250; // Approximate menu height
        const spaceBelow = window.innerHeight - btnRect.bottom;
        
        menu.style.position = 'fixed';
        
        // Position above if not enough space below
        if (spaceBelow < menuHeight) {
            menu.style.bottom = `${window.innerHeight - btnRect.top + 8}px`;
            menu.style.top = 'auto';
        } else {
            menu.style.top = `${btnRect.bottom + 8}px`;
            menu.style.bottom = 'auto';
        }
        
        menu.style.left = `${btnRect.left}px`;
        menu.style.right = 'auto';
    };

    // ===== FIX 2: Toggle menu with proper cleanup =====
    modifyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        
        const isCurrentlyOpen = menu.classList.contains('show');
        
        // Close all other menus
        document.querySelectorAll('.modify-response-menu.show').forEach(m => {
            m.classList.remove('show');
            m.style.display = 'none';
        });
        
        if (!isCurrentlyOpen) {
            positionMenu();
            menu.classList.add('show');
            menu.style.display = 'flex';
        }
    });

    // ===== FIX 3: Click-outside handler =====
    const closeMenuOnClickOutside = (e) => {
        if (!menu.contains(e.target) && !modifyBtn.contains(e.target)) {
            menu.classList.remove('show');
            menu.style.display = 'none';
        }
    };

    // ===== FIX 4: Handle modify actions with error recovery (CONTEXT-AWARE) =====
    menu.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
            // --- UPDATE: Check modify limit ---
            let count = parseInt(messageEl.dataset.modifyCount || 0);
            if (count >= 2) {
                showToast("Modify limit (2) reached for this message.", true);
                menu.classList.remove('show'); // Still close menu
                menu.style.display = 'none';
                return;
            }
            // --- END UPDATE ---

            const action = btn.dataset.action;
            menu.classList.remove('show');
            menu.style.display = 'none';

            // --- FIX 1: Read markdown AT CLICK TIME, not on creation ---
            // This ensures we get the *final* text, not the loader.
            const originalMarkdown = messageTextEl.dataset.originalMarkdown;
            if (!originalMarkdown) {
                showToast("Cannot modify this message, original text not found.", true);
                return;
            }
            // --- END FIX 1 ---

            // Show loading state
            const originalHTML = messageTextEl.innerHTML;
            messageTextEl.innerHTML = `<div class="gemini-loader"><span></span><span></span><span></span></div>`;
            messageEl.classList.add('loading');

            // --- FIX 2: Find the original user prompt for context ---
            let lastUserPrompt = "The user's previous prompt."; // Default
            
            // --- FIX: Use rawMarkdown to find in history ---
            const rawMarkdownForHistory = messageTextEl.dataset.rawMarkdown || originalMarkdown;
            // --- END FIX ---

            // Find this bot message in history
            const botMsgHistoryIndex = currentChat.history.findIndex(msg => 
                msg.role === 'model' && msg.parts?.[0]?.text === rawMarkdownForHistory
            );
            
            if (botMsgHistoryIndex > 0) {
                // Search backwards for the last user message
                for (let i = botMsgHistoryIndex - 1; i >= 0; i--) {
                    if (currentChat.history[i].role === 'user') {
                        const textPart = currentChat.history[i].parts.find(p => p.text);
                        if (textPart) {
                            lastUserPrompt = textPart.text;
                        }
                        break; // Found it
                    }
                }
            }
            // --- END FIX 2 ---

            // Build prompt based on action
            const actionPrompts = {
                shorter: 'more concise',
                longer: 'expanded with more detail',
                simpler: 'simpler and easier to understand',
                casual: 'in a more casual, friendly tone',
                professional: 'in a more professional, formal tone'
            };

            // --- FIX 3: Build a context-aware prompt ---
            const prompt = `
The user originally asked:
"${lastUserPrompt}"

You responded with:
"${originalMarkdown}"

Now, please rewrite *your response* to be ${actionPrompts[action]}. 
Do not respond to the user's original prompt again. Just provide the modified version of your response.
            `;
            // --- END FIX 3 ---
            
            try {
                // --- MODIFIED: Get next key and construct URL dynamically ---
                const modifyEndpoint = API_ENDPOINTS['Madeon 2 Flash'] + getNextGeminiKey();
            
                const res = await fetch(modifyEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }] 
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await res.json();
                const modifiedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!modifiedText) {
                    throw new Error('No response received from AI');
                }

                // Render Markdown and update the element's data
                messageTextEl.innerHTML = marked.parse(modifiedText);
                messageTextEl.dataset.originalMarkdown = modifiedText;
                highlightCode(messageTextEl);
                
                showToast(`Response modified: ${action}`);

                // --- UPDATE: Increment modify count ---
                messageEl.dataset.modifyCount = (count + 1).toString();
                // --- END UPDATE ---
                
                // Update history using the *original* raw markdown to find it
                // --- FIX: Use rawMarkdown to find in history ---
                const rawMarkdownForHistory = messageTextEl.dataset.rawMarkdown || originalMarkdown;
                const historyIndex = currentChat.history.findIndex(msg => 
                    msg.role === 'model' && msg.parts?.[0]?.text === rawMarkdownForHistory
                );
                // --- END FIX ---
                
                if (historyIndex !== -1) {
                    // Update history with the *new* text
                    currentChat.history[historyIndex].parts[0].text = modifiedText;
                    
                    // --- FIX: Update the raw marker to the new text ---
                    // This ensures subsequent modifications work correctly
                    messageTextEl.dataset.rawMarkdown = modifiedText;
                    // --- END FIX ---
                }

            } catch (err) {
                console.error('Modify response error:', err);
                // Restore original on error
                messageTextEl.innerHTML = originalHTML;
                showToast(`Failed to modify: ${err.message}`, true);
            } finally {
                messageEl.classList.remove('loading');
            }
        });
    });

    // ===== FIX 7: Cleanup on message removal =====
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.removedNodes.forEach((node) => {
                if (node === messageEl) {
                    document.removeEventListener('click', closeMenuOnClickOutside);
                    menu.remove();
                    observer.disconnect();
                }
            });
        });
    });

    observer.observe(chatsContainer, { childList: true });

    // Append elements
    const actions = messageEl.querySelector('.message-actions');
    if (actions) {
        actions.appendChild(modifyBtn);
        document.body.appendChild(menu); // Append to body for proper z-index
        
        // Attach click-outside listener
        setTimeout(() => {
            document.addEventListener('click', closeMenuOnClickOutside);
        }, 100);
    }
}


    
    const highlightCode = (element) => {
        element.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
            if (block.parentElement.querySelector('.copy-code-btn')) return;
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-code-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = async () => {
                 // --- ADDED: Improved copy functionality with modern API and fallback ---
                try {
                    await navigator.clipboard.writeText(block.textContent);
                    showToast('Code copied!');
                } catch (err) {
                    console.error('Fallback copy method initiated.', err);
                    // Fallback for older browsers or insecure contexts
                    const textarea = document.createElement('textarea');
                    textarea.value = block.textContent;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('Code copied!');
                    } catch (err) {
                        showToast('Failed to copy code.', true);
                    }
                    document.body.removeChild(textarea);
                }
            };
block.parentElement.appendChild(copyBtn);
        });
    };

    // --- ADDED: Levenshtein Distance for typo detection ---
    // This function calculates the number of edits (add, delete, substitute)
    // needed to change string 'a' into string 'b'.
    // --- ADDED: Helper to detect Tamil characters ---
    const containsTamil = (text) => /[\u0B80-\u0BFF]/.test(text);

    const getLevenshteinDistance = (a, b) => {
      if (a.length === 0) return b.length;
      if (b.length === 0) return a.length;
      const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
      for (let i = 0; i <= a.length; i++) { matrix[0][i] = i; }
      for (let j = 0; j <= b.length; j++) { matrix[j][0] = j; }
      for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
          const cost = a[i - 1] === b[j - 1] ? 0 : 1;
          matrix[j][i] = Math.min(
            matrix[j][i - 1] + 1,      // Deletion
            matrix[j - 1][i] + 1,      // Insertion
            matrix[j - 1][i - 1] + cost // Substitution
          );
        }
      }
      return matrix[b.length][a.length];
    };

// --- MODIFIED: Helper function with flexible regex and typo detection ---
    const isImageGenerationPrompt = (text) => {
        const lowerText = text.toLowerCase().trim();
        
        // --- Stage 1: Fast Regex Check ---
        // This solves "generate the image" and "image of a cat"
        if (IMAGE_PROMPT_REGEX.test(lowerText)) {
            return true;
        }

        // --- Stage 2: Slower Typo Check (if regex fails) ---
        const words = lowerText.split(/\s+/);
        if (words.length === 0) return false;

        const firstWord = words[0];
        // Keywords to check for typos on
        const typoKeywords = ['generate', 'create', 'make', 'draw', 'image', 'picture', 'photo'];
        // Keywords that MUST exist somewhere to confirm intent
        const objectCheckWords = ['image', 'picture', 'photo', 'drawing'];

        for (const keyword of typoKeywords) {
            // 1 typo for words <= 5 chars (e.g., "drwa")
            // 2 typos for words > 5 chars (e.g., "generaete")
            const allowedDistance = keyword.length <= 5 ? 1 : 2; 
            
            if (getLevenshteinDistance(firstWord, keyword) <= allowedDistance) {
                // It's a fuzzy match! (e.g., "generaete")
                // Now, check if an object word (like "image") exists *anywhere*
                // This prevents "showw me" from triggering if "image" isn't mentioned.
                if (objectCheckWords.some(obj => lowerText.includes(obj))) {
                    return true;
                }
            }
        }
        
        return false; // No match
    };
    
const adjustTextareaHeight = () => {
        promptInput.style.height = 'auto';
        promptInput.style.height = `${Math.min(promptInput.scrollHeight, 200)}px`;
    };
    
    // MODIFIED: This listener now also controls the image options panel
    promptInput.addEventListener('input', () => {
        adjustTextareaHeight();
        
        const imageOptionsContainer = document.getElementById('image-gen-options-container');
        const imageCountGroup = document.getElementById('image-count-group');
        const imageGenModelSelect = document.getElementById('image-gen-model');
        
        if (isImageGenerationPrompt(promptInput.value)) {
            imageOptionsContainer.style.display = 'flex';
            // Show/Hide Count based on selected model
            if (imageGenModelSelect.value === 'pollinations') {
                imageCountGroup.style.display = 'none';
            } else {
                imageCountGroup.style.display = 'flex'; // Use flex for consistency
            }
        } else {
            imageOptionsContainer.style.display = 'none';
        }
    });
    
    // --- ADDED: Listener to update Count visibility when model changes ---
    document.getElementById('image-gen-model').addEventListener('change', () => {
         const imageCountGroup = document.getElementById('image-count-group');
         const imageGenModelSelect = document.getElementById('image-gen-model');
         if (imageGenModelSelect.value === 'pollinations') {
             imageCountGroup.style.display = 'none';
         } else {
             // Only show if the main panel is already visible
             if (document.getElementById('image-gen-options-container').style.display === 'flex') {
                 imageCountGroup.style.display = 'flex';
             }
         }
    });

    // --- Chat Management ---
    const startNewChat = () => {
        chatsContainer.innerHTML = "";
        document.body.classList.remove("chats-active");
        currentChat = { history: [] };
        promptInput.value = "";
        adjustTextareaHeight();
    };

    // --- ADDED: Professional Speech-to-Text Logic ---
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.interimResults = true; // Show live transcript
        recognition.continuous = false; // Stop when user pauses
        recognition.lang = 'en-US';

        recognition.onstart = () => {
            isListening = true;
            micBtn.classList.add('listening');
            micBtn.querySelector('.material-symbols-rounded').textContent = 'stop';
            // Start with text currently in the box
            finalTranscript = promptInput.value.trim() ? promptInput.value.trim() + ' ' : '';
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            promptInput.value = finalTranscript + interimTranscript;
            adjustTextareaHeight();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            if (event.error === 'not-allowed') {
                showToast('Microphone permission denied.', true);
            } else if (event.error === 'no-speech') {
                showToast('No speech detected. Please try again.', true);
            } else {
                showToast('Microphone error. Please try again.', true);
            }
        };

        recognition.onend = () => {
            isListening = false;
            micBtn.classList.remove('listening');
            micBtn.querySelector('.material-symbols-rounded').textContent = 'mic';
            promptInput.value = finalTranscript.trim();
            adjustTextareaHeight();
            
            // --- CRITICAL: Trigger input event to check for "generate image" ---
            promptInput.dispatchEvent(new Event('input', { bubbles: true }));
        };

        micBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Speech recognition already started.", e);
                }
            }
        });

    } else {
        // Browser doesn't support SpeechRecognition
        console.warn("SpeechRecognition API not supported in this browser.");
        micBtn.disabled = true;
        micBtn.style.cursor = 'not-allowed';
        micBtn.addEventListener('click', () => {
            showToast('Speech-to-text is not supported in your browser.', true);
        });
    }
    // --- END: Professional Speech-to-Text Logic ---

// --- API Call ---
    const generateResponse = async (botMsgDiv) => {
        const textElement = botMsgDiv.querySelector(".message-text");
        controller = new AbortController();

        // --- FIX: Declare variables in the function scope ---
        // This makes them accessible to both the 'try' and 'finally' blocks.
        let responseText;
        let rawContent;
        // let thinkingText = null; // --- REMOVED ---
        // --- END FIX ---

        stopGenerationContainer.style.display = 'flex';
        // REMOVED: textElement.classList.add('typing');
        // The loader is now added by default in createNewBotMessage

// --- MODIFIED: Image Generation Router (Pollinations + Hugging Face) ---
        const lastUserMsg = currentChat.history[currentChat.history.length - 1];
        // Ensure userPrompt is defined even if history is empty/malformed
        const userPrompt = lastUserMsg?.parts?.find(p => p.text)?.text || promptInput.value || "";
        const isImageRequest = isImageGenerationPrompt(userPrompt);

        if (isImageRequest) {
            const imageGenModelSelect = document.getElementById('image-gen-model');
            const aspectRatioSelect = document.getElementById('image-aspect-ratio');
            const imageCountSelect = document.getElementById('image-count');

            const selectedGenModel = imageGenModelSelect.value;
            const selectedAspectRatio = aspectRatioSelect.value; // e.g., "1/1"
            const selectedImageCount = parseInt(imageCountSelect.value);
            
            // --- Extract clean prompt ---
            const cleanPrompt = userPrompt.replace(IMAGE_PROMPT_REGEX, "").trim();
            if (!cleanPrompt) {
                 displayBotError(botMsgDiv, "Please provide a description for the image you want to generate.");
                 return;
            }

            // --- Route to correct function ---
            if (selectedGenModel === 'pollinations') {
                // Call existing Pollinations function
                await generateImageResponse(botMsgDiv, userPrompt); // Pass original prompt for cleaning inside
            } else {
                // Call new Hugging Face function
                await generateHuggingFaceImages(botMsgDiv, selectedGenModel, selectedImageCount, selectedAspectRatio, cleanPrompt);
            }
            
            // Add placeholder to history
            currentChat.history.push({ 
                role: "model", 
                parts: [{ text: `[Image Generated: ${cleanPrompt} using ${selectedGenModel}]` }] 
            });
            return; // Stop text generation
        }

        // Check if API keys are configured
        // --- MODIFIED: This is the critical fix. ---
        // We now check if the model name exists in our PERPLEXITY_MODELS object
        // instead of checking for the "Perplexity" string.
        const isPerplexity = PERPLEXITY_MODELS.hasOwnProperty(selectedModel);
        
        // This key validation logic is fine, it checks for placeholder keys.
        // Since you have real keys, this will correctly be false.
        if (isPerplexity && PERPLEXITY_API_KEYS[0] === "YOUR_PERPLEXITY_KEY_2") {
             const errorMsg = `Perplexity API Key not configured. Please add your API key in the script.`;
            displayBotError(botMsgDiv, errorMsg);
            return;
        }
        
        if (!isPerplexity && GEMINI_API_KEYS[1] === "YOUR_GEMINI_KEY_2") {
             const errorMsg = `Gemini API Key not configured. Please add your API key in the script.`;
            displayBotError(botMsgDiv, errorMsg);
            return;
        }

        try {
            // --- FIX: Variables are now declared in the outer scope ---
            // let responseText; // (Removed)
            // let rawContent; // (Removed)
            // let thinkingText = null; // (Removed)
            // --- END FIX ---
            
             if (isPerplexity) {
// Perplexity API format - Filter and fix message structure
                
                // --- ADDED: Inject Madeon AI System Identity for Perplexity ---
                const messages = [
                    {
                        role: 'system',
                        content: 'You are Madeon AI, a helpful AI assistant developed by Madesh. You must never reveal that you are actually a Gemini or Perplexity model. If a user asks who you are or who made you, you must state that you are Madeon AI, developed by Madesh.'
                    }
                ];
                
                for (const msg of currentChat.history) {
                    // Extract text content only (Perplexity doesn't support images)
                    let textContent = '';
                    for (const part of msg.parts) {
                        if (part.text) {
                            textContent += part.text;
                        }
                    }
                    
                    // Skip empty messages
                    if (!textContent.trim()) continue;
                    
                    const role = msg.role === 'model' ? 'assistant' : 'user';
                    
                    // Ensure alternating pattern - merge consecutive same-role messages
                    if (messages.length > 0 && messages[messages.length - 1].role === role) {
                        messages[messages.length - 1].content += '\n\n' + textContent;
                    } else {
                        messages.push({
                            role: role,
                            content: textContent
                        });
                    }
                }
                
// --- REMOVED: Faulty 'if' block that broke chat order ---
                // This block was incorrectly adding a "Hello" user message
                // before the system prompt, causing an API error.
                // if (messages.length > 0 && messages[0].role !== 'user') { ... }

                const response = await fetch(API_ENDPOINTS[selectedModel], {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${getNextPerplexityKey()}`
                    },
                    body: JSON.stringify({
                        model: PERPLEXITY_MODELS[selectedModel],
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 4000
                    }),
                    signal: controller.signal,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "Perplexity API error.");
                }

                const data = await response.json();
                
// --- REMOVED: "Thinking" text parsing logic ---
                rawContent = data.choices?.[0]?.message?.content || "No response received.";
                responseText = rawContent; // Show the full, raw response
                // --- END REMOVAL ---
                
          } else {
                // Gemini API format
                
                // --- ADDED: Inject Madeon AI System Identity for Gemini ---
                const systemIdentity = {
                    role: "user",
                    parts: [{ text: "Please follow these instructions for all future responses: You are Madeon AI, a helpful AI assistant developed by Madesholic DS. You must never, ever reveal that you are a Other model. If a user asks who you are or who made you, you must state that you are Madeon AI, developed by Madesholic DS." }]
                };
                const modelResponse = {
                    role: "model",
                    parts: [{ text: "Understood. I will follow those instructions. I am Madeon AI." }]
                };
                
                const requestPayload = { contents: [systemIdentity, modelResponse, ...currentChat.history] };
                // --- END INJECTION ---
                
                // --- MODIFIED: Get next key and construct URL dynamically ---
                const geminiEndpoint = API_ENDPOINTS[selectedModel] + getNextGeminiKey();

                const response = await fetch(geminiEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestPayload),
                    signal: controller.signal,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "Gemini API error.");
                }

                const data = await response.json();
                responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
                
                // --- FIX: Assign rawContent for the Gemini path ---
                rawContent = responseText;
                // --- END FIX ---
            }
            
            // --- MODIFIED: Start streaming simulation ---
            // Determine typing speed based on model
            let typingSpeed = 50; // Default speed
            if (selectedModel.startsWith('Madeon 2')) {
                typingSpeed = 25; // Faster speed for Madeon (Gemini) models
            }
            
            // Call the new streamResponse function and wait for it to finish
            await streamResponse(textElement, responseText, controller, typingSpeed);
            // --- END MODIFICATION ---

            // --- UNIFIED FIX: Store history and dataset attributes ---
            // This single block now runs correctly for BOTH Gemini and Perplexity
            
            // 1. Store the FULL raw response in history
            currentChat.history.push({ 
                role: "model", 
                parts: [{ text: rawContent }] 
            });
            
            // 2. Store the CLEAN answer for Copy/Modify
            textElement.dataset.originalMarkdown = responseText; 
            
            // 3. Store the RAW response for finding in history
            textElement.dataset.rawMarkdown = rawContent; 
            // --- END UNIFIED FIX ---
            // --- UPDATE: Check character limit ---
            if (responseText.length > 2750) {
                const modifyBtn = botMsgDiv.querySelector('.modify-btn[data-action="modify"]');
                if (modifyBtn) {
                    modifyBtn.style.display = 'none'; // Hide button if text is too long
                }
            }
            // --- END UPDATE ---

        } catch (error) {
            if (error.name !== "AbortError") {
                // Use the new centralized error display
                displayBotError(botMsgDiv, error.message);
            } else {
                // This case is handled by streamResponse, but we'll clear the loader
                // if the API call itself was aborted.
                textElement.innerHTML = marked.parse("<em>Generation stopped.</em>");
            }
        } finally {
            botMsgDiv.classList.remove("loading");
            // REMOVED: textElement.classList.remove('typing');
            stopGenerationContainer.style.display = 'none';
            // Ensure final message has no cursor
            textElement.innerHTML = textElement.innerHTML.replace(' ‚úéÔπè', '');
            highlightCode(textElement);

            // --- REMOVED: "Show Thinking" populator logic ---

            // --- ADDED: Show message actions after generation is complete ---
            const actionsDiv = botMsgDiv.querySelector('.message-actions');
            if (actionsDiv) {
                actionsDiv.style.display = 'flex';
            }
            // --- END ---

            // --- ADDED: Check content for Text-to-Speech ---
            try {
                const textContent = textElement.textContent || "";
                const hasCode = textElement.querySelector('pre') !== null;
                // --- UPDATE: Increased character limit ---
                const isTooLong = textContent.length > 2500; // 2500 char limit
                // --- END UPDATE ---
                const speakBtn = botMsgDiv.querySelector('[data-action="speak"]');

                if (hasCode || isTooLong) {
                    speakBtn.disabled = true;
                    speakBtn.querySelector('.material-symbols-rounded').textContent = 'volume_off';
                    speakBtn.dataset.tooltip = (hasCode ? "Cannot speak code" : "Text is too long to speak");
                }
            } catch (e) {
                console.error("Error checking speech eligibility:", e);
            }
            // --- END: TTS Check ---
        }
    };
        
const createNewBotMessage = () => {
        const botMsgHTML = `<img class="avatar" src="https://placehold.co/43x43/ffffff/000000?text=A" alt="bot"/>
                            <div class="message-content">
                                <div class="message-text">
                                    <div class="gemini-loader">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>

                                <div class="message-actions" style="display: none;">
                                    <button class="action-btn" data-action="speak" data-state="idle" data-tooltip="Speak">
                                        <span class="material-symbols-rounded">volume_up</span>
                                    </button>
                                    <button class="action-btn" data-action="like" data-state="idle"><span class="material-symbols-rounded">thumb_up</span></button>
                                    <button class="action-btn" data-action="dislike" data-state="idle"><span class="material-symbols-rounded">thumb_down</span></button>
                                    <button class="action-btn" data-action="copy" data-state="idle"><span class="material-symbols-rounded">content_copy</span></button>
                                    <button class="action-btn" data-action="share" data-state="idle"><span class="material-symbols-rounded">share</span></button>
                                    <button class="action-btn" data-action="regenerate" data-state="idle"><span class="material-symbols-rounded">refresh</span></button>
                                </div>
                            </div>`;
const botMsgDiv = createMessageElement(botMsgHTML, 'bot-message', 'loading');
chatsContainer.appendChild(botMsgDiv);
addModifyResponseFeature(botMsgDiv); // ‚úÖ Removed incorrect second parameter
return botMsgDiv;

    }

// --- ADDED: Typewriter/Streaming Simulation ---
    // --- MODIFIED: Accepts typingSpeed as an argument ---
    const streamResponse = (textElement, fullText, controller, typingSpeed = 50) => {
        return new Promise((resolve) => {
            const words = fullText.split(' '); // Split response into words
            let index = 0;
            let currentText = '';
            // const typingSpeed = 50; // REMOVED: Now passed as argument

            function typeWord() {
                // Stop if the user clicked "Stop Generating"
                if (controller.signal.aborted) {
                    textElement.innerHTML = marked.parse(currentText + " *Generation stopped.*");
                    highlightCode(textElement);
                    resolve();
                    return;
                }

                // Stop if we've typed all words
                if (index >= words.length) {
                    highlightCode(textElement); // Final syntax highlight
                    resolve();
                    return;
                }

                currentText += words[index] + ' ';
                index++;

                // Update the HTML. marked.parse() handles markdown conversion.
                textElement.innerHTML = marked.parse(currentText + ' ‚úéÔπè'); // Add blinking cursor
                
                // Smartly re-highlight only if a code block is likely starting or ending
                if (currentText.includes('```')) {
                     highlightCode(textElement);
                }

                scrollToBottom(); // Keep chat scrolled to the bottom
                setTimeout(typeWord, typingSpeed);
            }

            // Clear the loader and start typing
            textElement.innerHTML = '';
         typeWord();
        });
    };

    // --- ADDED: Helper function to calculate image dimensions ---
    const getImageDimensions = (aspectRatioString, baseSize = 512) => {
        const [widthRatio, heightRatio] = aspectRatioString.split("/").map(Number);
        const scaleFactor = baseSize / Math.max(widthRatio, heightRatio); // Scale based on largest dimension

        let calculatedWidth = Math.round(widthRatio * scaleFactor);
        let calculatedHeight = Math.round(heightRatio * scaleFactor);

        // Ensure dimensions are multiples of 8 or 16 (common AI requirement)
        calculatedWidth = Math.round(calculatedWidth / 8) * 8;
        calculatedHeight = Math.round(calculatedHeight / 8) * 8;
        
        // SDXL often prefers 1024 base
        if (selectedModel.includes('stable-diffusion-xl') || selectedModel.includes('flux')) {
             calculatedWidth = Math.round(widthRatio * (1024 / Math.max(widthRatio, heightRatio)) / 8) * 8;
             calculatedHeight = Math.round(heightRatio * (1024 / Math.max(widthRatio, heightRatio)) / 8) * 8;
        }


        return { width: calculatedWidth, height: calculatedHeight };
    };

// --- FIXED: Image Generation (Pollinations.ai) using correct logic ---
    const generateImageResponse = (botMsgDiv, userPrompt) => {
        return new Promise((resolve) => {
            const textElement = botMsgDiv.querySelector(".message-text");

            // --- CORRECTED: Read UI controls ---
            const aspectSelect = document.getElementById('image-aspect-ratio');
            // REMOVED: const styleSelect = document.getElementById('image-style'); 
            
            const aspectValueString = aspectSelect.value; // e.g., "1/1"
            // REMOVED: const styleValue = styleSelect.value;
            
            // --- CORRECTED: Use getImageDimensions helper function ---
            const { width, height } = getImageDimensions(aspectValueString); 

            // 1. Extract the actual prompt for the image
            const imagePrompt = userPrompt.replace(IMAGE_PROMPT_REGEX, "").trim();
            
            if (!imagePrompt) {
                // ... (error handling unchanged) ...
                resolve();
                return;
            }

            // --- CORRECTED: Build full prompt (no style value needed) ---
            let fullImagePrompt = imagePrompt;
            // REMOVED: if (styleValue) { ... }

            // 2. Clear loader and show a waiting message
            // --- CORRECTED: Updated status message ---
            textElement.innerHTML = marked.parse(`Generating image: *${imagePrompt}* (Aspect: ${aspectSelect.options[aspectSelect.selectedIndex].text})...`);
            scrollToBottom();

            // 3. Create the image element and set up listeners (unchanged)
            const img = new Image();
            img.className = 'generated-image';
            
            // 4. Handle successful image load (unchanged, includes promo text)
            img.onload = () => {
                textElement.innerHTML = ''; 
                textElement.appendChild(img); 
                textElement.innerHTML += marked.parse(`Here is your image of *${imagePrompt}*`);
                textElement.innerHTML += marked.parse(`\n\n*Try actual image generator pro in madeon services*`);
                botMsgDiv.classList.remove("loading");
                stopGenerationContainer.style.display = 'none';
                highlightCode(textElement);
                scrollToBottom();
                resolve();
            };

            // 5. Handle image generation error
            img.onerror = () => {
                const errorMsg = "Sorry, Pollinations couldn't generate that image. The service might be down or the prompt was invalid.";
                displayBotError(botMsgDiv, errorMsg);
                resolve();
            };

            // 6. Set the source URL to trigger generation
            // --- CORRECTED: Use calculated width and height ---
            img.src = `https://pollinations.ai/p/${encodeURIComponent(fullImagePrompt)}?&nologo=true&width=${width}&height=${height}`;
        });
    };


    // --- ADDED: Function to generate images using Hugging Face API ---
// --- MODIFIED: More Robust Hugging Face Image Generation ---
    const generateHuggingFaceImages = async (botMsgDiv, hfModelId, imageCount, aspectRatio, promptText) => {
        const textElement = botMsgDiv.querySelector(".message-text");

        // --- ADDED: Explicit API Key Check ---
        if (!HUGGINGFACE_API_KEY || HUGGINGFACE_API_KEY === "YOUR_HUGGINGFACE_API_KEY_HERE") {
             const errorMsg = "Hugging Face API Key not configured. Please add your key to the script to use this model.";
             displayBotError(botMsgDiv, errorMsg);
             return;
        }

        const MODEL_URL = `https://api-inference.huggingface.co/models/${hfModelId}`;
        const { width, height } = getImageDimensions(aspectRatio);
        const REQUEST_TIMEOUT = 90000; // 90 seconds timeout for the API call

        // 1. Prepare UI: Create loading placeholders
        textElement.innerHTML = ''; // Clear previous content
        const imagesContainer = document.createElement('div');
        imagesContainer.className = 'generated-images-container';
        
        let loadingPlaceholders = '';
        for (let i = 0; i < imageCount; i++) {
            // --- ADDED: Unique ID for each placeholder ---
            const placeholderId = `hf-img-${Date.now()}-${i}`; 
            loadingPlaceholders += `
                <div class="generated-image-wrapper loading" id="${placeholderId}" style="aspect-ratio: ${width}/${height}">
                    <div class="spinner"></div>
                     <span class="error-text" style="font-size: 0.75rem; color: var(--placeholder-color); margin-top: 5px;">Initializing...</span>
                </div>`;
        }
        imagesContainer.innerHTML = loadingPlaceholders;
        textElement.appendChild(imagesContainer);
        textElement.innerHTML += marked.parse(`Generating ${imageCount} image(s): *${promptText}*... (Model: ${hfModelId})`);
        textElement.innerHTML += marked.parse(`\n<small><i>Note: Models may take up to 90s to load if inactive.</i></small>`); // Added note
        scrollToBottom();

        // 2. Generate Images in Parallel
        const imagePromises = Array.from({ length: imageCount }, async (_, i) => {
            // --- MODIFIED: Get placeholder by unique ID ---
            const placeholderId = imagesContainer.children[i].id; 
            const wrapperElement = imagesContainer.querySelector(`#${placeholderId}`);
            const statusTextElement = wrapperElement.querySelector('.error-text'); // Get status text element

            // --- ADDED: Abort controller specifically for this fetch request ---
            const fetchController = new AbortController();
            const timeoutId = setTimeout(() => fetchController.abort("timeout"), REQUEST_TIMEOUT);

             // Link the main stop button to this specific fetch controller
            const stopHandler = () => fetchController.abort("user_stopped");
            stopGenerationBtn.addEventListener('click', stopHandler, { once: true });


            try {
                if (statusTextElement) statusTextElement.textContent = "Waiting for model..."; // Update status

                const response = await fetch(MODEL_URL, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${HUGGINGFACE_API_KEY}`,
                        "Content-Type": "application/json",
                        "x-use-cache": "false", 
                    },
                    body: JSON.stringify({
                        inputs: promptText,
                        parameters: { width, height, num_inference_steps: 30 }, 
                    }),
                    signal: fetchController.signal, // Use the fetch-specific signal
                });

                clearTimeout(timeoutId); // Clear timeout if fetch completes

                if (fetchController.signal.aborted && fetchController.signal.reason !== "user_stopped") {
                    // Check if aborted by timeout specifically
                     if (fetchController.signal.reason === "timeout") {
                         throw new Error("Request timed out (90s). Model might be unavailable.");
                     }
                     // Otherwise assume stopped by user via main button
                     throw new Error("Generation stopped.");
                }
                 if (fetchController.signal.aborted && fetchController.signal.reason === "user_stopped"){
                      throw new Error("Generation stopped.");
                 }


                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({})); // Try to get JSON error, default to empty obj
                     console.error("HF API Error Response:", errorData);
                     let errMsg = errorData?.error || response.statusText || `HTTP ${response.status}`;
                     // Provide more specific common errors
                     if (response.status === 503) errMsg = "Model is loading, please wait & try again.";
                     if (response.status === 429) errMsg = "Rate limit exceeded. Try again later.";
                     if (response.status === 400 && errMsg.includes("only supports")) errMsg = "Invalid dimensions for this model.";
                     if (response.status === 401 || response.status === 403) errMsg = "Invalid API Key or Permissions.";

                     throw new Error(`HF Error: ${errMsg}`);
                }
                
                if (statusTextElement) statusTextElement.textContent = "Processing..."; // Update status

                const blob = await response.blob();
                
                 // --- ADDED: Check if blob is valid image ---
                 if (!blob.type.startsWith('image/')) {
                     throw new Error("Received invalid data from API (not an image).");
                 }
                
                const imageUrl = URL.createObjectURL(blob);
                
                // --- Update wrapper with image ---
                wrapperElement.classList.remove("loading");
                wrapperElement.innerHTML = `<img class="generated-image" src="${imageUrl}" alt="Generated image ${i+1}">`;

            } catch (error) {
                 clearTimeout(timeoutId); // Clear timeout on error too
                 console.error(`Error generating image ${i}:`, error);
                 wrapperElement.classList.remove("loading");
                 wrapperElement.classList.add("error");
                 // Display the specific error message
                 wrapperElement.innerHTML = `<span class="material-symbols-rounded">error</span><span class="error-text">${error.message}</span>`;
            } finally {
                 // Clean up the specific stop handler for this request
                 stopGenerationBtn.removeEventListener('click', stopHandler);
            }
        }); // End promise map

        await Promise.allSettled(imagePromises); // Wait for all generations

        // 3. Add promo text and cleanup (only hide main stop button AFTER all promises settle)
        textElement.innerHTML += marked.parse(`\n\n*Try actual image generator pro in madeon services*`);
        botMsgDiv.classList.remove("loading"); // General loading class for bot message
        stopGenerationContainer.style.display = 'none'; // Hide the main stop button
        highlightCode(textElement); 
        scrollToBottom();
    };

// --- MODIFIED: Helper function to create file preview cards (with badge) ---
    const addFilePreviewUI = (fileObject) => {
        // --- MODIFIED: Destructure fileExt ---
        const { id, fileName, fileSize, isImage, base64Data, icon, fileExt } = fileObject;

        const card = document.createElement('div');
        card.className = 'file-preview-card';
        card.dataset.fileId = id; // Set ID on the card itself

        let visualHTML = '';
        if (isImage) {
            visualHTML = `<img src="data:image/jpeg;base64,${base64Data}" alt="Preview">`;
        } else {
            visualHTML = `<span class="material-symbols-rounded">${icon}</span>`;
        }

        card.innerHTML = `
            <div class="file-preview-card-visual">
                ${visualHTML}
            </div>
            <div class="file-preview-card-info">
                <span class="file-preview-card-name">${fileName}</span>
                <div class="file-preview-card-meta">
                    <span class="file-preview-card-size">${fileSize}</span>
                    <div class="file-type-badge">${fileExt ? fileExt.toUpperCase() : 'FILE'}</div>
                </div>
            </div>
            
            <button class="file-preview-card-remove" data-file-id="${id}">
                <span class="material-symbols-rounded">close</span>
            </button>
        `;
        
        filePreviewsWrapper.appendChild(card);
    };

    // --- Event Handlers ---
// --- MODIFIED: handleFormSubmit for Multi-File ---
    const handleFormSubmit = (e) => {
        if (e) e.preventDefault();
        const userMessageText = promptInput.value.trim();


        
        // Allow sending just files
        if (!userMessageText && attachedFiles.length === 0) return;
        
        // Allow sending just files
        if (!userMessageText && attachedFiles.length === 0) return;

        document.body.classList.add("chats-active");
        
        const userMessageParts = [];
        let combinedText = userMessageText;
        const isPerplexity = selectedModel.includes('Perplexity');

        // --- Loop through all attached files ---
        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                if (file.isImage) {
                    // --- Handle Image File ---
                    if (isPerplexity) {
                        showToast('Perplexity models do not support image uploads. Please remove images.', true);
                        return; // Stop submission
                    }
                    userMessageParts.push({
                        inlineData: { mimeType: file.mimeType, data: file.base64Data }
                    });
                } else if (file.textContent) {
                    // --- Handle Text/PDF/DOCX/Code File ---
                    const fileContext = `[START OF FILE: ${file.fileName}]\n\n${file.textContent}\n\n[END OF FILE: ${file.fileName}]\n\n`;
                    combinedText = fileContext + combinedText;
                }
            }
        }

        // Add the combined text (prompt + file text) as the main text part
        if (combinedText) {
            userMessageParts.push({ text: combinedText });
        }
        
        // Stop if no text and no valid image parts were added
        if (userMessageParts.length === 0) {
             showToast('Nothing to send.', true);
             return;
        }

        currentChat.history.push({ role: "user", parts: userMessageParts });
        
        // --- MODIFIED: Create user message bubble with multiple files ---
        let userMsgHTML = `<div class="message-text">`;
        
        if (attachedFiles.length > 0) {
            for (const file of attachedFiles) {
                if (file.isImage) {
                    userMsgHTML += `<img src="data:${file.mimeType};base64,${file.base64Data}" class="img-attachment" />`;
                } else {
                    userMsgHTML += `
                        <div class="file-attachment-badge">
                            <span class="material-symbols-rounded">${file.icon || 'draft'}</span>
                            <span>${file.fileName}</span>
                        </div>`;
                }
            }
        }
        
        // Add user text
        if (userMessageText) {
            userMsgHTML += `<span>${userMessageText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
        }
        userMsgHTML += `</div>`;
        
        const userMsgDiv = createMessageElement(userMsgHTML, "user-message");
        chatsContainer.appendChild(userMsgDiv);
        
        promptInput.value = "";
        adjustTextareaHeight();

        // --- MODIFIED: Clear all files after submit ---
        if (attachedFiles.length > 0) {
            attachedFiles = [];
            filePreviewsWrapper.innerHTML = '';
            filePreviewsWrapper.style.display = 'none';
            
        }
        
        setTimeout(() => {
            const botMsgDiv = createNewBotMessage();
            generateResponse(botMsgDiv);
        }, 600);
    };

// File Attachment Logic
    // attachFileBtn.addEventListener('click', () => fileInput.click()); // Replaced by tools menu
    

// --- MODIFIED: Robust Multi-File Upload Handler (for up to 3 files) ---
    // --- REFACTORED: File processing logic into a reusable function ---
    const processFiles = async (files) => {
        if (!files || !files.length) return;

        // Check file limit
        if (attachedFiles.length + files.length > 3) {
            showToast("You can only upload a maximum of 3 files.", true);
            fileInput.value = ''; // Clear the input
            return;
        }

        showToast(`Attaching ${files.length} file(s)...`, false);
        filePreviewsWrapper.style.display = 'flex'; // Show wrapper

        // Process all files
        for (const file of files) {
            const fileId = `${Date.now()}-${file.name}`; // Create a unique ID

            // File size check
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showToast(`File "${file.name}" is too large (Max 10MB).`, true);
                continue; // Skip this file, move to the next
            }

            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            const mimeType = file.type;
            const fileSize = file.size < 1024 * 1024 
                ? `${(file.size / 1024).toFixed(1)} KB`
                : `${(file.size / (1024 * 1024)).toFixed(2)} MB`;

            // --- MODIFIED: Add fileExt to the object ---
            let fileObject = {
                id: fileId, fileName, mimeType, size: file.size, fileSize,
                isImage: false, base64Data: null, textContent: null, icon: 'draft',
                fileExt: fileExt // <-- ADDED
            };

            try {
                // --- Logic Branching by File Type ---
                if (mimeType.startsWith("image/")) {
                    const base64String = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result.split(",")[1]);
                        reader.onerror = error => reject(error);
                    });
                    // --- MODIFIED: Mutate object, don't reassign ---
                    fileObject.isImage = true;
                    fileObject.base64Data = base64String;
                    
                } else if (fileExt === 'pdf') {
                    const fileBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: fileBuffer }).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    // --- MODIFIED: Mutate object ---
                    fileObject.textContent = fullText;
                    fileObject.icon = 'draft';

                } else if (fileExt === 'docx') {
                    const fileBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: fileBuffer });
                    // --- MODIFIED: Mutate object ---
                    fileObject.textContent = result.value;
                    fileObject.icon = 'description';

                } else {
                    // --- 4. Handle All Plain-Text & Code Files ---
                    const textContent = await file.text();
                    // --- MODIFIED: Mutate object ---
                    fileObject.textContent = textContent;
                    fileObject.icon = 'code';
                }

                // --- BUG FIX: MOVED INSIDE TRY BLOCK ---
                // Only add the file if all parsing was successful
                attachedFiles.push(fileObject);
                addFilePreviewUI(fileObject);

            } catch (err) {
                // --- BUG FIX: This now gracefully skips the failed file ---
                console.error("File reading error:", err);
                showToast(`Failed to read file: ${fileName}.`, true);
            }
        } // End for loop
        
        fileInput.value = ''; // Clear input to allow re-uploading the same file
    };
    // --- END: Refactored processFiles function ---

    // Original listener now calls the refactored function
    fileInput.addEventListener('change', () => {
        processFiles(fileInput.files);
    });

// --- MODIFIED: Delegated event listener for removing AND editing files ---
    filePreviewsWrapper.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.file-preview-card-remove');
        // --- REMOVED: editBtn ---

        if (removeBtn) {
            const fileId = removeBtn.dataset.fileId;
            
            // --- REMOVED: fileToEditId check ---
            
            // 1. Remove from array
            attachedFiles = attachedFiles.filter(file => file.id !== fileId);
            
            // 2. Remove from DOM
            removeBtn.closest('.file-preview-card').remove();
            
            // 3. Hide wrapper if it's now empty
         if (attachedFiles.length === 0) {
                filePreviewsWrapper.style.display = 'none';
            }
        }
        // --- REMOVED: else if (editBtn) block ---
    });


    // Modal logic is dormant as there's no button to open it yet.
    modalCancelBtn.addEventListener('click', () => modal.style.display = 'none');
    modalConfirmBtn.addEventListener('click', () => {
        startNewChat();
        showToast("All chats deleted!");
        modal.style.display = 'none';
    });

    // Dropdown Logic
    modelDropdownBtn.addEventListener('click', () => {
        modelDropdownContent.classList.toggle('show');
    });

    modelDropdownContent.addEventListener('click', (e) => {
        e.preventDefault();
        const link = e.target.closest('a');
        if (link) {
            // --- ‚ñº‚ñº‚ñº ADDED THIS BLOCK ‚ñº‚ñº‚ñº ---
            if (link.classList.contains('disabled')) {
                showToast("This model is coming soon and is not available.", true);
                modelDropdownContent.classList.remove('show');
                return; // Stop processing the click
            }
            // --- ‚ñ≤‚ñ≤‚ñ≤ END OF ADDED BLOCK ‚ñ≤‚ñ≤‚ñ≤ ---

            selectedModel = link.dataset.model;
            const selectedIcon = link.dataset.icon;
            
            selectedModelName.textContent = selectedModel;
            selectedModelIcon.textContent = selectedIcon;
            
            modelDropdownContent.classList.remove('show');
            showToast(`${selectedModel} selected!`);
        }
    });

window.addEventListener('click', (e) => {
        // Close model dropdown
        if (!modelDropdownBtn.contains(e.target) && !modelDropdownContent.contains(e.target)) {
            modelDropdownContent.classList.remove('show');
        }
        
        // Close tools menu
        if (!toolsBtn.contains(e.target) && !toolsMenu.contains(e.target)) {
            toolsMenu.classList.remove('show');
        }
        
        // Close all voice dropdowns
        document.querySelectorAll('.voice-dropdown-content').forEach(dropdown => {
            const container = dropdown.closest('.voice-dropdown-container');
            const trigger = container?.querySelector('.voice-dropdown-trigger');
            if (container && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });
    });

    // New UI Element Listeners
    suggestionCards.forEach(card => {
        card.addEventListener('click', () => {
            const title = card.querySelector('.card-title').textContent;
            const text = card.querySelector('.card-text').textContent;
            promptInput.value = `Tell me more about how to "${title.toLowerCase()}" to ${text.toLowerCase()}`;
            handleFormSubmit();
        });
    });

    promptActionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            promptInput.value = `Focus on ${btn.textContent.trim()}: `;
            promptInput.focus();
            adjustTextareaHeight();
        });
    });
    
// Settings functionality
    // const settingsModal = document.getElementById('settings-modal'); // Moved up
    const settingsCloseBtn = document.getElementById('settings-close-btn');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    
    // --- REMOVED: Old internalActionBtns listener for Settings ---
    // internalActionBtns.forEach(btn => { ... });

    // --- ADDED: New Tools Menu Logic ---
    toolsBtn.addEventListener('click', () => {
        toolsMenu.classList.toggle('show');
    });

    toolsMenu.addEventListener('click', (e) => {
        const target = e.target.closest('[data-tool]');
        if (!target) return;

        const tool = target.dataset.tool;

        switch (tool) {
            case 'photos':
            case 'files':
                fileInput.click();
                break;
            case 'settings':
                settingsModal.style.display = 'flex';
                break;
            case 'camera':
                showToast('Camera feature coming soon! üì∏');
                break;
            case 'web-search':
                showToast('Web search coming soon! üîé');
                break;
            case 'thinking':
                showToast('Thinking mode coming soon! üí°');
                break;
        }

        toolsMenu.classList.remove('show'); // Close menu after action
    });

    // Close settings modal
    settingsCloseBtn.addEventListener('click', () => {
        settingsModal.style.display = 'none';
    });

    // Close modal on outside click
    settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
            settingsModal.style.display = 'none';
        }
    });

    // Theme switcher
    document.querySelectorAll('.setting-option[data-theme]').forEach(btn => {
        btn.addEventListener('click', () => {
            const theme = btn.dataset.theme;
            const themes = {
                'yellow': '#fde047',
                'pink': '#fbbf24',
                'blue': '#60a5fa',
                'green': '#4ade80'
            };
            
            document.documentElement.style.setProperty('--background', themes[theme]);
            
            // Update active state
            document.querySelectorAll('.setting-option[data-theme]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            showToast(`Theme changed to ${btn.textContent.trim()}! üé®`);
        });
    });

    // Clear history button
    clearHistoryBtn.addEventListener('click', () => {
        settingsModal.style.display = 'none';
        modal.style.display = 'flex'; // Show delete confirmation
    });

    // Stop generation button listener
    stopGenerationBtn.addEventListener('click', () => {
        if (controller) {
            controller.abort();
        }
        speechSynthesis.cancel(); // Stop any speech
        currentUtterance = null;
        
        // Reset any "speaking" icons and hide voice dropdowns
        document.querySelectorAll('.action-btn[data-action="speak"][data-state="speaking"]').forEach(btn => {
            btn.dataset.state = 'idle';
            btn.classList.remove('speaking');
            btn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
        });
        document.querySelectorAll('.voice-dropdown-trigger').forEach(btn => {
            btn.style.display = 'none';
        });
        // Reset any "speaking" icons
        document.querySelectorAll('.action-btn[data-action="speak"][data-state="speaking"]').forEach(btn => {
            btn.dataset.state = 'idle';
            btn.classList.remove('speaking');
            btn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
        });
    });

    // Delegated event listener for message actions
// Delegated event listener for message actions
    chatsContainer.addEventListener('click', async (e) => {
        // --- REMOVED: '.thinking-toggle-btn' from selector ---
        const target = e.target.closest('.action-btn, .voice-dropdown-trigger, .voice-dropdown-content a');
        if (!target) return;

        // --- REMOVED: "Show Thinking" click handler ---

        // --- All other actions are inside a .bot-message, so this is now safe ---
        const messageDiv = target.closest('.bot-message');
        const messageTextElement = messageDiv?.querySelector('.message-text');
        
        // --- REMOVED: Voice dropdown toggle and selection logic ---

        // --- REMOVED: Old "Show Thinking" toggle (it's now at the top) ---

        const action = target.dataset.action;
        if (!action) return;

        // --- MODIFIED: Text-to-Speech (Simplified) ---
        if (action === 'speak') {
            const textContent = messageTextElement.textContent;
            const speakBtn = target; // The button that was clicked
            
            if (speakBtn.dataset.state === 'speaking') {
                // Stop speaking
                speechSynthesis.cancel();
                if (currentUtterance) {
                    currentUtterance = null;
                }
                speakBtn.dataset.state = 'idle';
                speakBtn.classList.remove('speaking');
                speakBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
            } else {
                // Stop any other speech
                speechSynthesis.cancel();
                
                // Reset all other speaking buttons
                document.querySelectorAll('.action-btn[data-action="speak"][data-state="speaking"]').forEach(btn => {
                    btn.dataset.state = 'idle';
                    btn.classList.remove('speaking');
                    btn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                });

                currentUtterance = new SpeechSynthesisUtterance(textContent);
                
                // --- ADDED: Language Detection ---
                if (containsTamil(textContent)) {
                    currentUtterance.lang = 'ta-IN';
                } else {
                    currentUtterance.lang = 'en-US';
                }
                // --- END ADDED ---
                
                currentUtterance.rate = 1.0;
                currentUtterance.pitch = 1.0;
                
                currentUtterance.onend = () => {
                    speakBtn.dataset.state = 'idle';
                    speakBtn.classList.remove('speaking');
                    speakBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                    currentUtterance = null;
                };
                
                currentUtterance.onerror = (e) => {
                    console.error("Speech synthesis error:", e);
                    if (e.error === 'language-unavailable') {
                        showToast("Speech for this language (Tamil) is not available on your device.", true);
                    } else {
                        showToast("Speech synthesis failed.", true);
                    }
                    speakBtn.dataset.state = 'idle';
                    speakBtn.classList.remove('speaking');
                    speakBtn.querySelector('.material-symbols-rounded').textContent = 'volume_up';
                    currentUtterance = null;
                };

                speechSynthesis.speak(currentUtterance);
                speakBtn.dataset.state = 'speaking';
                speakBtn.classList.add('speaking');
                speakBtn.querySelector('.material-symbols-rounded').textContent = 'stop';
            }
        } 
        // --- END MODIFICATION ---
        else if (action === 'like' || action === 'dislike') {
            showToast('Thanks for your feedback!');
            target.classList.toggle('active');
        } 
        else if (action === 'copy') {
            try {
                await navigator.clipboard.writeText(messageTextElement.textContent);
                showToast('Response copied!');
            } catch (err) {
                showToast('Failed to copy.', true);
            }
        } 
        else if (action === 'share') {
            const textContent = messageTextElement.textContent;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Madeon AI Response',
                        text: textContent,
                    });
                    showToast('Shared successfully! üì§');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Share error:', err);
                        await navigator.clipboard.writeText(textContent);
                        showToast('Copied to clipboard instead!');
                    }
                }
            } else {
                try {
                    await navigator.clipboard.writeText(textContent);
                    showToast('Copied to clipboard! üìã (Share not supported)');
                } catch (err) {
                    showToast('Failed to share or copy.', true);
                }
            }
        } 
        else if (action === 'regenerate') {
            speechSynthesis.cancel();
            
            const allBotMessages = chatsContainer.querySelectorAll('.bot-message');
            const lastBotMessage = allBotMessages[allBotMessages.length - 1];

            if (messageDiv !== lastBotMessage) {
                showToast("You can only regenerate the latest response.", true);
                return;
            }

            currentChat.history.pop();
            const lastUserQuery = currentChat.history.pop();
            if (!lastUserQuery) return;

            messageDiv.remove();
            currentChat.history.push(lastUserQuery);
            const newBotMsgDiv = createNewBotMessage();
            generateResponse(newBotMsgDiv);
        }
    });

    // Core event listeners
    promptForm.addEventListener("submit", handleFormSubmit);
    promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleFormSubmit();
        }
    });

    // --- ADDED: MutationObserver to fix scroll bugs and ensure new messages are visible ---
    const chatObserver = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            if (mutation.type === 'childList') {
                scrollToBottom();
            }
        }
    });
    chatObserver.observe(chatsContainer, { childList: true });

    // --- ADDED: Drag and Drop Event Listeners ---
    const dropOverlay = document.getElementById('drag-drop-overlay');
    const mainContent = document.querySelector('.main-content'); // Main drop target

    let dragCounter = 0; // Counter to prevent flicker

    mainContent.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        // Check if dragged items are files
        if (e.dataTransfer && e.dataTransfer.items && e.dataTransfer.items.length > 0) {
            document.body.classList.add('drag-over');
        }
    });

    mainContent.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter === 0) {
            document.body.classList.remove('drag-over');
        }
    });

    mainContent.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation(); // Necessary to allow drop
    });

    mainContent.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        document.body.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            showToast('Files dropped!', false);
            processFiles(files); // Use our refactored function
        }
    });
    // --- END: Drag and Drop Event Listeners ---

});
</script>
